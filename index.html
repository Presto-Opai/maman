<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>El Viaje de Ana Lucila</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
html, body { width: 100%; height: 100%; overflow: hidden; background: #1a1a2e; font-family: 'Georgia', serif; }
canvas { display: block; cursor: pointer; touch-action: none; }

/* Start screen */
#start-screen {
  position: fixed; top: 0; left: 0; width: 100%; height: 100%;
  background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
  display: flex; flex-direction: column; align-items: center; justify-content: center;
  z-index: 100; color: #fff; text-align: center;
}
#start-screen h1 {
  font-size: clamp(28px, 6vw, 56px); margin-bottom: 10px;
  font-style: italic; color: #e8d5b7;
  text-shadow: 2px 2px 8px rgba(0,0,0,0.5);
}
#start-screen .subtitle {
  font-size: clamp(14px, 3vw, 22px); color: #c9a96e; margin-bottom: 50px;
}
#start-screen button {
  display: block; margin: 10px auto; padding: 16px 40px;
  font-size: clamp(16px, 3vw, 22px); font-family: 'Georgia', serif;
  border: 2px solid #c9a96e; background: transparent; color: #e8d5b7;
  border-radius: 8px; cursor: pointer; transition: all 0.3s;
  min-width: 260px;
}
#start-screen button:hover { background: #c9a96e; color: #1a1a2e; }
#start-screen button:disabled { opacity: 0.3; cursor: default; }
#start-screen button:disabled:hover { background: transparent; color: #e8d5b7; }

/* HUD */
#hud {
  position: fixed; top: 0; left: 0; width: 100%; padding: 8px 12px;
  background: rgba(0,0,0,0.6); color: #fff; font-size: clamp(11px, 2.2vw, 15px);
  z-index: 10; pointer-events: none; backdrop-filter: blur(4px);
}
#hud .quest-line { padding: 2px 0; }
#hud .quest-line.completed { text-decoration: line-through; opacity: 0.4; }
#hud .quest-line .candle { color: #f5c842; }

/* Dialogue box */
#dialogue-box {
  position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
  width: min(90%, 600px); background: rgba(20, 20, 40, 0.92);
  border: 2px solid #c9a96e; border-radius: 12px; padding: 16px 20px;
  color: #e8d5b7; font-size: clamp(14px, 2.8vw, 18px); z-index: 20;
  display: none; cursor: pointer; backdrop-filter: blur(6px);
  line-height: 1.5;
}
#dialogue-box .speaker { color: #f5c842; font-weight: bold; margin-bottom: 4px; }
#dialogue-box .tap-hint { font-size: 11px; color: #888; text-align: right; margin-top: 6px; }

/* Sculpture mini-game */
#sculpture-game {
  position: fixed; top: 0; left: 0; width: 100%; height: 100%;
  background: rgba(0,0,0,0.85); z-index: 50; display: none;
  flex-direction: column; align-items: center; justify-content: center; color: #fff;
}
#sculpture-game h2 { margin-bottom: 20px; color: #e8d5b7; font-size: clamp(18px, 4vw, 28px); }
#sculpture-game .sculpture-container {
  display: flex; flex-direction: column; align-items: center; gap: 4px; margin-bottom: 20px;
}
#sculpture-game .sculpture-row {
  display: flex; align-items: center; gap: 10px;
}
#sculpture-game .sculpture-part {
  width: clamp(80px, 20vw, 140px); height: clamp(50px, 10vw, 70px);
  background: #3a3a5c; border: 2px solid #c9a96e; border-radius: 6px;
  display: flex; align-items: center; justify-content: center;
  font-size: clamp(16px, 4vw, 26px); user-select: none;
}
#sculpture-game .arrow-btn {
  width: 40px; height: 40px; background: #c9a96e; border: none; border-radius: 50%;
  font-size: 20px; cursor: pointer; color: #1a1a2e; font-weight: bold;
}
#sculpture-game .arrow-btn:hover { background: #e8d5b7; }
#sculpture-game .validate-btn {
  padding: 12px 30px; font-size: 18px; background: #4a9e4a; border: none;
  border-radius: 8px; color: #fff; cursor: pointer; font-family: 'Georgia', serif;
}
#sculpture-game .validate-btn:hover { background: #5cb85c; }
#sculpture-game .error-msg { color: #e74c3c; margin-top: 10px; font-size: 14px; }

/* End screen */
#end-screen {
  position: fixed; top: 0; left: 0; width: 100%; height: 100%;
  background: rgba(0,0,0,0.9); z-index: 100; display: none;
  flex-direction: column; align-items: center; justify-content: center;
  color: #fff; text-align: center;
}
#end-screen h1 {
  font-size: clamp(24px, 5vw, 48px); color: #f5c842;
  font-style: italic; margin-bottom: 20px;
  text-shadow: 0 0 20px rgba(245, 200, 66, 0.5);
}
#end-screen p { font-size: clamp(16px, 3vw, 24px); color: #e8d5b7; margin-bottom: 40px; }
#end-screen button {
  padding: 14px 36px; font-size: 20px; border: 2px solid #c9a96e;
  background: transparent; color: #e8d5b7; border-radius: 8px;
  cursor: pointer; font-family: 'Georgia', serif;
}
#end-screen button:hover { background: #c9a96e; color: #1a1a2e; }

/* Mini-map */
#minimap {
  position: fixed; bottom: 10px; right: 10px;
  width: clamp(100px, 20vw, 160px); height: clamp(66px, 13vw, 106px);
  border: 2px solid #c9a96e; border-radius: 6px;
  background: rgba(0,0,0,0.6); z-index: 10;
  pointer-events: none; overflow: hidden;
}
#minimap canvas { width: 100%; height: 100%; }

/* Region label */
#region-label {
  position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
  font-size: clamp(28px, 6vw, 56px); color: #e8d5b7; font-style: italic;
  text-shadow: 2px 2px 10px rgba(0,0,0,0.8); z-index: 15;
  pointer-events: none; opacity: 0; transition: opacity 0.5s;
}
</style>
</head>
<body>

<!-- Start Screen -->
<div id="start-screen">
  <h1>El Viaje de Ana Lucila</h1>
  <div class="subtitle">Un jeu d'anniversaire</div>
  <button id="btn-new">Nouvelle Partie</button>
  <button id="btn-continue" disabled>Continuer</button>
</div>

<!-- Game Canvas -->
<canvas id="game-canvas"></canvas>

<!-- HUD -->
<div id="hud" style="display:none;"></div>

<!-- Dialogue -->
<div id="dialogue-box">
  <div class="speaker"></div>
  <div class="text"></div>
  <div class="tap-hint">‚ñº cliquer pour continuer</div>
</div>

<!-- Region Label -->
<div id="region-label"></div>

<!-- Mini-map -->
<div id="minimap" style="display:none;"><canvas id="minimap-canvas" width="160" height="106"></canvas></div>

<!-- Sculpture Mini-Game -->
<div id="sculpture-game">
  <h2>Sculpter une danseuse</h2>
  <div class="sculpture-container" id="sculpture-container"></div>
  <button class="validate-btn" id="sculpture-validate">Valider !</button>
  <div class="error-msg" id="sculpture-error"></div>
</div>

<!-- End Screen -->
<div id="end-screen">
  <h1>Joyeux anniversaire Lucy !</h1>
  <p>Je t'aime maman.</p>
  <button id="btn-restart">Recommencer</button>
</div>

<script>
// ============================================================
// EL VIAJE DE ANA LUCILA ‚Äî Complete Game
// ============================================================

const canvas = document.getElementById('game-canvas');
const ctx = canvas.getContext('2d');

// ---- Constants ----
const TILE = 40;
const PLAYER_SPEED = 3.5;
const NPC_INTERACT_DIST = 60;
const ITEM_PICKUP_DIST = 50;

// Seeded random for consistent decorations
let _seed = 42;
function seededRandom() {
  _seed = (_seed * 16807 + 0) % 2147483647;
  return (_seed - 1) / 2147483646;
}

// ---- World dimensions ----
// World is a big map: 6 regions laid out in a grid
// Each region is 40x30 tiles = 1600x1200 px
const REGION_W = 40 * TILE; // 1600
const REGION_H = 30 * TILE; // 1200

// Layout: 3 cols x 2 rows
// Row 0: V√©lizy | Cuernavaca | Acapulco
// Row 1: Paris  | Grenoble   | Athis-de-l'Orne
const WORLD_W = 3 * REGION_W; // 4800
const WORLD_H = 2 * REGION_H; // 2400

const REGIONS = {
  velizy:      { col: 0, row: 0, name: 'V√©lizy',          emoji: 'üè´', color: '#4a7c59' },
  cuernavaca:  { col: 1, row: 0, name: 'Cuernavaca',      emoji: 'üá≤üáΩ', color: '#c4a35a' },
  acapulco:    { col: 2, row: 0, name: 'Acapulco',        emoji: 'üèñÔ∏è', color: '#d4b876' },
  paris:       { col: 0, row: 1, name: 'Paris',           emoji: 'üá´üá∑', color: '#6a6a8a' },
  grenoble:    { col: 1, row: 1, name: 'Grenoble',        emoji: '‚õ∞Ô∏è', color: '#5a7a5a' },
  athis:       { col: 2, row: 1, name: "Athis-de-l'Orne", emoji: 'üêÑ', color: '#6a9a4a' },
};

function regionOrigin(regionKey) {
  const r = REGIONS[regionKey];
  return { x: r.col * REGION_W, y: r.row * REGION_H };
}

function regionCenter(regionKey) {
  const o = regionOrigin(regionKey);
  return { x: o.x + REGION_W / 2, y: o.y + REGION_H / 2 };
}

// ---- Game State ----
let gameState = null;

function newGameState() {
  return {
    playerX: regionOrigin('velizy').x + 620,
    playerY: regionOrigin('velizy').y + 200,
    targetX: null,
    targetY: null,
    quests: {
      carmen:     { status: 'not_started', tortillas: 0 },
      piquis:     { status: 'not_started', erikaFollowing: false },
      lupita:     { status: 'not_started', hasSac: false },
      valerie:    { status: 'not_started', sculptureComplete: false },
      grenoble:   { status: 'not_started' },
      apolline:   { status: 'not_started', foundArthur: false },
    },
    talkedTo: {},
    completedQuests: [],
    allComplete: false,
    currentRegion: 'velizy',
  };
}

// ---- Camera ----
let camX = 0, camY = 0;

function updateCamera() {
  camX = gameState.playerX - canvas.width / 2;
  camY = gameState.playerY - canvas.height / 2;
  camX = Math.max(0, Math.min(camX, WORLD_W - canvas.width));
  camY = Math.max(0, Math.min(camY, WORLD_H - canvas.height));
}

// ---- Resize ----
function resize() {
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
}
window.addEventListener('resize', resize);
resize();

// ---- Decorations & Buildings per region ----
// Each building: { x, y, w, h, color, label, labelColor }
// Positions are relative to region origin

function getRegionBuildings(regionKey) {
  const o = regionOrigin(regionKey);
  const ox = o.x, oy = o.y;
  const buildings = [];
  const decorations = [];

  switch (regionKey) {
    case 'velizy': {
      // School
      buildings.push({ x: ox+200, y: oy+200, w: 200, h: 120, color: '#8B7355', label: '√âcole', labelColor: '#fff', type: 'school' });
      // Houses
      buildings.push({ x: ox+600, y: oy+100, w: 100, h: 80, color: '#a08060', label: 'Maison', labelColor: '#fff', type: 'house' });
      buildings.push({ x: ox+800, y: oy+300, w: 120, h: 80, color: '#907050', label: 'Maison', labelColor: '#fff', type: 'house' });
      buildings.push({ x: ox+1000, y: oy+150, w: 140, h: 100, color: '#b09070', label: 'Boulangerie', labelColor: '#fff', type: 'shop' });
      buildings.push({ x: ox+500, y: oy+600, w: 160, h: 100, color: '#5a8a4a', label: 'Parc', labelColor: '#fff', type: 'park' });
      // Gathering area (for finale)
      buildings.push({ x: ox+250, y: oy+700, w: 200, h: 20, color: '#6a5a4a', label: 'Place du village', labelColor: '#ddd', type: 'plaza' });
      // Cour Roland (with park)
      buildings.push({ x: ox+1200, y: oy+500, w: 200, h: 130, color: '#9a8a6a', label: 'Cour Roland', labelColor: '#fff', type: 'park' });
      // Fountain at Cour Roland
      decorations.push({ x: ox + 1300, y: oy + 650, type: 'fountain' });
      // Trees scattered around
      for (let i = 0; i < 25; i++) {
        decorations.push({ x: ox + 80 + seededRandom()*1400, y: oy + 80 + seededRandom()*1050, type: 'tree' });
      }
      // Flowers
      for (let i = 0; i < 20; i++) {
        decorations.push({ x: ox + 50 + seededRandom()*1500, y: oy + 50 + seededRandom()*1100, type: 'flower' });
      }
      // Benches
      for (let i = 0; i < 5; i++) {
        decorations.push({ x: ox + 100 + seededRandom()*1300, y: oy + 200 + seededRandom()*800, type: 'bench' });
      }
      // Lamp posts
      for (let i = 0; i < 6; i++) {
        decorations.push({ x: ox + 100 + seededRandom()*1400, y: oy + 100 + seededRandom()*1000, type: 'lamp' });
      }
      // Bushes
      for (let i = 0; i < 12; i++) {
        decorations.push({ x: ox + 50 + seededRandom()*1500, y: oy + 50 + seededRandom()*1100, type: 'bush' });
      }
      // Butterflies
      for (let i = 0; i < 4; i++) {
        decorations.push({ x: ox + 100 + seededRandom()*1400, y: oy + 100 + seededRandom()*800, type: 'butterfly' });
      }
      // Fountain in the parc
      decorations.push({ x: ox + 580, y: oy + 640, type: 'fountain' });
      // Mail box
      decorations.push({ x: ox + 750, y: oy + 400, type: 'mailbox' });
      // Bike rack
      decorations.push({ x: ox + 420, y: oy + 400, type: 'bike' });
      break;
    }
    case 'cuernavaca': {
      // Sombrero shop
      buildings.push({ x: ox+300, y: oy+300, w: 180, h: 120, color: '#d4a050', label: 'Tienda de Sombreros', labelColor: '#fff', type: 'mexican' });
      // Market
      buildings.push({ x: ox+700, y: oy+200, w: 200, h: 100, color: '#c09040', label: 'Mercado', labelColor: '#fff', type: 'mexican' });
      buildings.push({ x: ox+600, y: oy+600, w: 140, h: 90, color: '#b08030', label: 'Cantina', labelColor: '#fff', type: 'mexican' });
      buildings.push({ x: ox+1000, y: oy+400, w: 120, h: 80, color: '#a07030', label: 'Casa', labelColor: '#fff', type: 'house' });
      buildings.push({ x: ox+200, y: oy+700, w: 100, h: 70, color: '#c07840', label: 'Iglesia', labelColor: '#fff', type: 'mexican' });
      // Cacti
      for (let i = 0; i < 18; i++) {
        decorations.push({ x: ox + 60 + seededRandom()*1450, y: oy + 60 + seededRandom()*1050, type: 'cactus' });
      }
      // Flowers (bougainvillea)
      for (let i = 0; i < 15; i++) {
        decorations.push({ x: ox + 50 + seededRandom()*1500, y: oy + 50 + seededRandom()*1100, type: 'bougainvillea' });
      }
      // Pottery / jars
      for (let i = 0; i < 8; i++) {
        decorations.push({ x: ox + 100 + seededRandom()*1400, y: oy + 100 + seededRandom()*1000, type: 'pottery' });
      }
      // Sombrero decorations
      for (let i = 0; i < 4; i++) {
        decorations.push({ x: ox + 200 + seededRandom()*1200, y: oy + 200 + seededRandom()*800, type: 'sombrero' });
      }
      // String lights (papel picado)
      for (let i = 0; i < 5; i++) {
        decorations.push({ x: ox + 150 + seededRandom()*1300, y: oy + 150 + seededRandom()*400, type: 'papel_picado' });
      }
      // Butterflies
      for (let i = 0; i < 3; i++) {
        decorations.push({ x: ox + 100 + seededRandom()*1400, y: oy + 100 + seededRandom()*900, type: 'butterfly' });
      }
      // Fountain in the plaza
      decorations.push({ x: ox + 550, y: oy + 850, type: 'fountain' });
      // Market stalls
      for (let i = 0; i < 4; i++) {
        decorations.push({ x: ox + 800 + seededRandom()*400, y: oy + 350 + i * 80, type: 'market_stall' });
      }
      break;
    }
    case 'acapulco': {
      // Hotel
      buildings.push({ x: ox+300, y: oy+200, w: 260, h: 160, color: '#e0c080', label: 'Hotel Acapulco Princess', labelColor: '#333', type: 'hotel' });
      // Beach bar
      buildings.push({ x: ox+600, y: oy+500, w: 140, h: 90, color: '#d0b070', label: 'Restaurante', labelColor: '#fff', type: 'mexican' });
      buildings.push({ x: ox+150, y: oy+500, w: 100, h: 70, color: '#c8a060', label: 'Bar de Playa', labelColor: '#fff', type: 'shop' });
      // Palm trees
      for (let i = 0; i < 18; i++) {
        decorations.push({ x: ox + 50 + seededRandom()*950, y: oy + 50 + seededRandom()*1100, type: 'palm' });
      }
      // Beach umbrellas
      for (let i = 0; i < 8; i++) {
        decorations.push({ x: ox + 800 + seededRandom()*400, y: oy + 100 + seededRandom()*800, type: 'umbrella' });
      }
      // Shells
      for (let i = 0; i < 12; i++) {
        decorations.push({ x: ox + 700 + seededRandom()*500, y: oy + 50 + seededRandom()*1100, type: 'shell' });
      }
      // Seagulls
      for (let i = 0; i < 6; i++) {
        decorations.push({ x: ox + 200 + seededRandom()*1200, y: oy + 50 + seededRandom()*400, type: 'seagull' });
      }
      // Flowers
      for (let i = 0; i < 10; i++) {
        decorations.push({ x: ox + 50 + seededRandom()*800, y: oy + 100 + seededRandom()*1000, type: 'tropical_flower' });
      }
      // Surfboards
      for (let i = 0; i < 3; i++) {
        decorations.push({ x: ox + 850 + seededRandom()*300, y: oy + 700 + seededRandom()*300, type: 'surfboard' });
      }
      // Hammock
      decorations.push({ x: ox + 200, y: oy + 800, type: 'hammock' });
      break;
    }
    case 'paris': {
      // Aero Mexico office
      buildings.push({ x: ox+300, y: oy+300, w: 220, h: 130, color: '#7a7a9a', label: 'Bureau Aero Mexico', labelColor: '#fff', type: 'parisian' });
      // Lancel shop
      buildings.push({ x: ox+900, y: oy+400, w: 160, h: 100, color: '#9a8a7a', label: 'Boutique Lancel', labelColor: '#fff', type: 'parisian' });
      // Eiffel-ish
      buildings.push({ x: ox+600, y: oy+100, w: 80, h: 200, color: '#8a8a8a', label: 'Tour Eiffel', labelColor: '#ddd', type: 'eiffel' });
      buildings.push({ x: ox+200, y: oy+600, w: 130, h: 90, color: '#6a6a7a', label: 'Caf√©', labelColor: '#fff', type: 'parisian' });
      buildings.push({ x: ox+1100, y: oy+200, w: 120, h: 80, color: '#7a6a5a', label: 'Brasserie', labelColor: '#fff', type: 'parisian' });
      buildings.push({ x: ox+1000, y: oy+700, w: 110, h: 80, color: '#6a7a8a', label: 'Librairie', labelColor: '#fff', type: 'parisian' });
      // Trees (plane trees like in Paris)
      for (let i = 0; i < 14; i++) {
        decorations.push({ x: ox + 80 + seededRandom()*1400, y: oy + 80 + seededRandom()*1050, type: 'plane_tree' });
      }
      // Lamp posts (r√©verb√®res)
      for (let i = 0; i < 10; i++) {
        decorations.push({ x: ox + 50 + seededRandom()*1500, y: oy + 50 + seededRandom()*1100, type: 'paris_lamp' });
      }
      // Pigeons
      for (let i = 0; i < 8; i++) {
        decorations.push({ x: ox + 100 + seededRandom()*1400, y: oy + 100 + seededRandom()*1000, type: 'pigeon' });
      }
      // Caf√© tables
      for (let i = 0; i < 6; i++) {
        decorations.push({ x: ox + 150 + seededRandom()*1300, y: oy + 400 + seededRandom()*700, type: 'cafe_table' });
      }
      // Flowers
      for (let i = 0; i < 8; i++) {
        decorations.push({ x: ox + 50 + seededRandom()*1500, y: oy + 50 + seededRandom()*1100, type: 'flower' });
      }
      // Statue
      decorations.push({ x: ox + 800, y: oy + 250, type: 'statue' });
      // Kiosque √† journaux
      decorations.push({ x: ox + 450, y: oy + 450, type: 'kiosk' });
      // Fontaine Wallace
      decorations.push({ x: ox + 700, y: oy + 650, type: 'fountain' });
      break;
    }
    case 'grenoble': {
      // Bottom area - city
      buildings.push({ x: ox+200, y: oy+800, w: 180, h: 100, color: '#6a7a6a', label: 'Gare', labelColor: '#fff', type: 'house' });
      buildings.push({ x: ox+600, y: oy+900, w: 150, h: 90, color: '#5a6a5a', label: 'Maison', labelColor: '#fff', type: 'house' });
      // T√©l√©ph√©rique station bottom
      buildings.push({ x: ox+500, y: oy+700, w: 100, h: 60, color: '#8a7a5a', label: 'T√©l√©ph√©rique ‚Üë', labelColor: '#ff0', type: 'station' });
      // Bastille at top
      buildings.push({ x: ox+500, y: oy+100, w: 200, h: 120, color: '#7a8a6a', label: 'La Bastille', labelColor: '#fff', type: 'castle' });
      buildings.push({ x: ox+900, y: oy+850, w: 130, h: 80, color: '#5a7a6a', label: 'Fromagerie', labelColor: '#fff', type: 'shop' });
      // Mountain rocks
      for (let i = 0; i < 30; i++) {
        decorations.push({ x: ox + 60 + seededRandom()*1450, y: oy + 30 + seededRandom()*650, type: 'rock' });
      }
      // Pine trees
      for (let i = 0; i < 20; i++) {
        decorations.push({ x: ox + 60 + seededRandom()*1450, y: oy + 50 + seededRandom()*1100, type: 'pine' });
      }
      // Trees in valley
      for (let i = 0; i < 12; i++) {
        decorations.push({ x: ox + 100 + seededRandom()*1400, y: oy + 600 + seededRandom()*500, type: 'tree' });
      }
      // Wildflowers
      for (let i = 0; i < 15; i++) {
        decorations.push({ x: ox + 50 + seededRandom()*1500, y: oy + 300 + seededRandom()*800, type: 'wildflower' });
      }
      // Snow patches on top
      for (let i = 0; i < 6; i++) {
        decorations.push({ x: ox + 100 + seededRandom()*1400, y: oy + 20 + seededRandom()*200, type: 'snow' });
      }
      // Mountain goats
      for (let i = 0; i < 3; i++) {
        decorations.push({ x: ox + 100 + seededRandom()*1400, y: oy + 200 + seededRandom()*400, type: 'goat' });
      }
      // Alpine cabin
      decorations.push({ x: ox + 1200, y: oy + 500, type: 'cabin' });
      break;
    }
    case 'athis': {
      // Mairie
      buildings.push({ x: ox+300, y: oy+200, w: 200, h: 130, color: '#8a9a7a', label: 'Mairie', labelColor: '#fff', type: 'house' });
      // Maze area (visual indicator)
      buildings.push({ x: ox+700, y: oy+300, w: 500, h: 500, color: '#3a5a2a', label: 'Jardin-Labyrinthe', labelColor: '#cfc', type: 'garden' });
      // Farms
      buildings.push({ x: ox+200, y: oy+600, w: 120, h: 80, color: '#7a8a5a', label: 'Ferme', labelColor: '#fff', type: 'farm' });
      buildings.push({ x: ox+100, y: oy+850, w: 110, h: 70, color: '#8a7a5a', label: '√âtable', labelColor: '#fff', type: 'farm' });
      buildings.push({ x: ox+400, y: oy+900, w: 100, h: 70, color: '#6a8a5a', label: 'Fromagerie', labelColor: '#fff', type: 'shop' });
      // Cows
      for (let i = 0; i < 10; i++) {
        decorations.push({ x: ox + 80 + seededRandom()*550, y: oy + 350 + seededRandom()*750, type: 'cow' });
      }
      // Trees
      for (let i = 0; i < 18; i++) {
        decorations.push({ x: ox + 50 + seededRandom()*1500, y: oy + 50 + seededRandom()*1100, type: 'tree' });
      }
      // Hay bales
      for (let i = 0; i < 6; i++) {
        decorations.push({ x: ox + 100 + seededRandom()*500, y: oy + 500 + seededRandom()*600, type: 'hay' });
      }
      // Flowers
      for (let i = 0; i < 15; i++) {
        decorations.push({ x: ox + 50 + seededRandom()*1500, y: oy + 50 + seededRandom()*1100, type: 'wildflower' });
      }
      // Fences
      for (let i = 0; i < 8; i++) {
        decorations.push({ x: ox + 50 + seededRandom()*600, y: oy + 400 + seededRandom()*700, type: 'fence' });
      }
      // Pond
      decorations.push({ x: ox + 450, y: oy + 500, type: 'pond' });
      // Swallows
      for (let i = 0; i < 4; i++) {
        decorations.push({ x: ox + 100 + seededRandom()*1400, y: oy + 50 + seededRandom()*300, type: 'swallow' });
      }
      // Well
      decorations.push({ x: ox + 350, y: oy + 450, type: 'well' });
      // Wheelbarrow
      decorations.push({ x: ox + 250, y: oy + 750, type: 'wheelbarrow' });
      // Chickens
      for (let i = 0; i < 5; i++) {
        decorations.push({ x: ox + 100 + seededRandom()*500, y: oy + 700 + seededRandom()*400, type: 'chicken' });
      }
      break;
    }
  }
  return { buildings, decorations };
}

// Precompute all buildings
let allBuildings = [];
let allDecorations = [];
function buildWorld() {
  allBuildings = [];
  allDecorations = [];
  _seed = 42; // Reset seed for consistent decoration placement
  for (const key of Object.keys(REGIONS)) {
    const { buildings, decorations } = getRegionBuildings(key);
    allBuildings.push(...buildings);
    allDecorations.push(...decorations);
  }
}

// ---- Maze for Athis ----
const MAZE_ORIGIN_X = regionOrigin('athis').x + 720;
const MAZE_ORIGIN_Y = regionOrigin('athis').y + 320;
const MAZE_CELL = 50;
const MAZE_COLS = 9;
const MAZE_ROWS = 9;

// Simple predefined maze (1 = wall, 0 = path)
const MAZE_GRID = [
  [1,1,1,1,1,1,1,1,1],
  [1,0,0,0,1,0,0,0,1],
  [1,0,1,0,1,0,1,0,1],
  [1,0,1,0,0,0,1,0,1],
  [1,0,1,1,1,0,1,0,1],
  [1,0,0,0,0,0,1,0,1],
  [1,1,1,0,1,1,1,0,1],
  [1,0,0,0,0,0,0,0,1],
  [1,1,1,0,0,0,1,1,1],
];

// Maze entrance at bottom-center
const MAZE_ENTRANCE = { col: 3, row: 7 };
// Arthur & C√©leste at center
const MAZE_CENTER = { col: 3, row: 3 };

function mazeWorldPos(col, row) {
  return {
    x: MAZE_ORIGIN_X + col * MAZE_CELL + MAZE_CELL / 2,
    y: MAZE_ORIGIN_Y + row * MAZE_CELL + MAZE_CELL / 2,
  };
}

function isInMazeWall(wx, wy) {
  const col = Math.floor((wx - MAZE_ORIGIN_X) / MAZE_CELL);
  const row = Math.floor((wy - MAZE_ORIGIN_Y) / MAZE_CELL);
  if (col < 0 || col >= MAZE_COLS || row < 0 || row >= MAZE_ROWS) return false;
  return MAZE_GRID[row][col] === 1;
}

// Maze decorations (carrots, camemberts, cows inside maze)
const mazeDecos = [];
function initMazeDecos() {
  mazeDecos.length = 0;
  _seed = 123; // Reset seed for consistent maze decoration placement
  const pathCells = [];
  for (let r = 0; r < MAZE_ROWS; r++) {
    for (let c = 0; c < MAZE_COLS; c++) {
      if (MAZE_GRID[r][c] === 0 && !(r === MAZE_CENTER.row && c === MAZE_CENTER.col)) {
        pathCells.push({r, c});
      }
    }
  }
  const types = ['carrot', 'camembert', 'cow', 'veggie'];
  for (let i = 0; i < 6; i++) {
    const cell = pathCells[Math.floor(seededRandom() * pathCells.length)];
    const pos = mazeWorldPos(cell.c, cell.r);
    mazeDecos.push({ x: pos.x, y: pos.y, type: types[i % types.length] });
  }
}

// ---- NPCs ----
function createNPCs() {
  const vo = regionOrigin('velizy');
  const co = regionOrigin('cuernavaca');
  const ao = regionOrigin('acapulco');
  const po = regionOrigin('paris');
  const go = regionOrigin('grenoble');
  const ato = regionOrigin('athis');

  return [
    // V√©lizy
    {
      id: 'gerard', name: 'G√©rard', region: 'velizy',
      x: vo.x + 650, y: vo.y + 200, color: '#e07050',
      emoji: 'üë¥', hasCandle: false,
      dialogue: () => {
        if (gameState.allComplete) return "Joyeux anniversaire ! Tout le monde est l√† !";
        return "Joyeux anniversaire ! Tu as parl√© √† tout le monde ?";
      },
    },
    {
      id: 'valerie', name: 'Val√©rie', region: 'velizy',
      x: vo.x + 250, y: vo.y + 350, color: '#d070a0',
      emoji: 'üë©‚Äçüè´', hasCandle: true, quest: 'valerie',
      dialogue: () => {
        const q = gameState.quests.valerie;
        if (q.status === 'completed') return "Joyeux anniversaire ! La sculpture est magnifique !";
        if (q.status === 'in_progress') {
          if (q.sculptureComplete) {
            q.status = 'completed';
            completeQuest('valerie');
            return "Joyeux anniversaire ! C'est exactement la danseuse que je voulais ! Merci !";
          }
          return "Joyeux anniversaire ! Va √† Cour Roland pour sculpter la danseuse !";
        }
        q.status = 'in_progress';
        saveGame();
        return "Joyeux anniversaire ! J'ai besoin d'une sculpture de danseuse. Va √† Cour Roland, le parc un peu plus loin, pour la cr√©er !";
      },
    },
    // Cuernavaca
    {
      id: 'carmen', name: 'Carmen', region: 'cuernavaca',
      x: co.x + 350, y: co.y + 450, color: '#e0a050',
      emoji: 'üë©', hasCandle: true, quest: 'carmen',
      dialogue: () => {
        const q = gameState.quests.carmen;
        if (q.status === 'completed') return "¬°Feliz cumplea√±os mi hija! ¬°Gracias por las tortillas!";
        if (q.status === 'in_progress') {
          if (q.tortillas >= 3) {
            q.status = 'completed';
            completeQuest('carmen');
            return "¬°Feliz cumplea√±os mi hija! ¬°Encontraste las tres tortillas! ¬°Gracias!";
          }
          return `¬°Feliz cumplea√±os mi hija! Necesito tres tortillas... Tienes ${q.tortillas}/3.`;
        }
        q.status = 'in_progress';
        saveGame();
        return "¬°Feliz cumplea√±os mi hija! ¬øPuedes traerme tres tortillas? ¬°Est√°n por alg√∫n lugar de la regi√≥n!";
      },
    },
    // Acapulco
    {
      id: 'piquis', name: 'Piquis', region: 'acapulco',
      x: ao.x + 430, y: ao.y + 400, color: '#70b0e0',
      emoji: 'üëµ', hasCandle: true, quest: 'piquis',
      dialogue: () => {
        const q = gameState.quests.piquis;
        if (q.status === 'completed') return "¬°Feliz cumplea√±os! ¬°Erika regres√≥, gracias!";
        if (q.status === 'in_progress') {
          if (q.erikaFollowing) {
            q.status = 'completed';
            completeQuest('piquis');
            return "¬°Feliz cumplea√±os! ¬°Erika, aqu√≠ est√°s! ¬°Gracias por traerla!";
          }
          return "¬°Feliz cumplea√±os! ¬øEncontraste a Erika? Est√° mirando el oc√©ano por all√°...";
        }
        q.status = 'in_progress';
        saveGame();
        return "¬°Feliz cumplea√±os! ¬øPuedes traerme a Erika? Se fue a mirar el oc√©ano m√°s lejos...";
      },
    },
    {
      id: 'erika', name: 'Erika', region: 'acapulco',
      x: ao.x + 1200, y: ao.y + 800, color: '#e070a0',
      emoji: 'üëß', hasCandle: false,
      dialogue: () => {
        const q = gameState.quests.piquis;
        if (q.status === 'completed') return "¬°El oc√©ano es tan hermoso!";
        if (q.status === 'in_progress' && !q.erikaFollowing) {
          q.erikaFollowing = true;
          saveGame();
          return "¬°Feliz cumplea√±os! ¬°Est√° bien, te sigo! ¬°Vamos a ver a Piquis!";
        }
        return "Estoy mirando el oc√©ano... es tan bonito aqu√≠.";
      },
    },
    // Paris
    {
      id: 'lupita', name: 'Lupita', region: 'paris',
      x: po.x + 350, y: po.y + 450, color: '#a070c0',
      emoji: 'üë©‚Äçüíº', hasCandle: true, quest: 'lupita',
      dialogue: () => {
        const q = gameState.quests.lupita;
        if (q.status === 'completed') return "Joyeux anniversaire ! J'adore mon sac Lancel !";
        if (q.status === 'in_progress') {
          if (q.hasSac) {
            q.status = 'completed';
            completeQuest('lupita');
            return "Joyeux anniversaire ! Oh, le sac Lancel ! Il est magnifique ! Merci !";
          }
          return "Joyeux anniversaire ! Tu as trouv√© le sac Lancel ? Regarde derri√®re la boutique Lancel !";
        }
        q.status = 'in_progress';
        saveGame();
        return "Joyeux anniversaire ! Peux-tu me ramener un sac Lancel ? La boutique est quelque part dans Paris !";
      },
    },
    // Grenoble - passant
    {
      id: 'passant_grenoble', name: 'Passant', region: 'grenoble',
      x: go.x + 300, y: go.y + 900, color: '#8a8a8a',
      emoji: 'üö∂', hasCandle: false,
      dialogue: () => "Joyeux anniversaire ! Je crois qu'ils sont √† la Bastille. Prenez le t√©l√©ph√©rique ou montez √† pied !",
    },
    // G√©raldine at top
    {
      id: 'geraldine', name: 'G√©raldine', region: 'grenoble',
      x: go.x + 550, y: go.y + 250, color: '#d070b0',
      emoji: 'üë©', hasCandle: true, quest: 'grenoble',
      dialogue: () => {
        const q = gameState.quests.grenoble;
        if (q.status === 'completed') return "Joyeux anniversaire maman !";
        q.status = 'completed';
        completeQuest('grenoble');
        saveGame();
        return "Joyeux anniversaire maman !";
      },
    },
    {
      id: 'hugo', name: 'Hugo', region: 'grenoble',
      x: go.x + 650, y: go.y + 260, color: '#5080c0',
      emoji: 'üë®', hasCandle: false,
      dialogue: () => "Joyeux anniversaire !",
    },
    {
      id: 'victor', name: 'Petit Victor', region: 'grenoble',
      x: go.x + 600, y: go.y + 280, color: '#80c080',
      emoji: 'üë∂', hasCandle: false,
      dialogue: () => "Grooa ! Joyeux anniversaire Abue !",
    },
    // Athis-de-l'Orne
    {
      id: 'apolline', name: 'Apolline', region: 'athis',
      x: ato.x + 350, y: ato.y + 350, color: '#c0a070',
      emoji: 'üë©‚Äçüíº', hasCandle: true, quest: 'apolline',
      dialogue: () => {
        const q = gameState.quests.apolline;
        if (q.status === 'completed') return "Joyeux anniversaire ! Les enfants sont contents !";
        if (q.status === 'in_progress') {
          if (q.foundArthur) {
            q.status = 'completed';
            completeQuest('apolline');
            return "Joyeux anniversaire ! Tu as retrouv√© Arthur et C√©leste ! Merci !";
          }
          return "Joyeux anniversaire ! Va dans le jardin-labyrinthe pour retrouver Arthur et C√©leste !";
        }
        q.status = 'in_progress';
        saveGame();
        return "Joyeux anniversaire ! Peux-tu retrouver Arthur et C√©leste dans le jardin-labyrinthe ?";
      },
    },
    // Arthur & C√©leste inside maze
    {
      id: 'arthur', name: 'Arthur', region: 'athis',
      x: mazeWorldPos(MAZE_CENTER.col, MAZE_CENTER.row).x - 15,
      y: mazeWorldPos(MAZE_CENTER.col, MAZE_CENTER.row).y,
      color: '#70a0d0', emoji: 'üë¶', hasCandle: false,
      dialogue: () => {
        const q = gameState.quests.apolline;
        // C√©leste always speaks right after Arthur
        setTimeout(() => showDialogue('B√©b√© C√©leste', 'Abadi abw√© !'), 100);
        if (q.status === 'in_progress') {
          q.foundArthur = true;
          saveGame();
          return "Joyeux anniversaire maman ! On rentre voir Apolline !";
        }
        return "Joyeux anniversaire !";
      },
    },
    {
      id: 'celeste', name: 'B√©b√© C√©leste', region: 'athis',
      x: mazeWorldPos(MAZE_CENTER.col, MAZE_CENTER.row).x + 15,
      y: mazeWorldPos(MAZE_CENTER.col, MAZE_CENTER.row).y + 10,
      color: '#f0a0c0', emoji: 'üë∂', hasCandle: false,
      dialogue: () => "Abadi abw√© !",
    },
  ];
}

let npcs = [];

// ---- Items ----
let items = [];

function createItems() {
  const co = regionOrigin('cuernavaca');
  const po = regionOrigin('paris');
  return [
    // 3 tortillas in Cuernavaca
    { id: 'tortilla1', type: 'tortilla', x: co.x + 800, y: co.y + 500, emoji: 'ü´ì', picked: false },
    { id: 'tortilla2', type: 'tortilla', x: co.x + 1100, y: co.y + 300, emoji: 'ü´ì', picked: false },
    { id: 'tortilla3', type: 'tortilla', x: co.x + 600, y: co.y + 800, emoji: 'ü´ì', picked: false },
    // Sac Lancel behind the boutique in Paris
    { id: 'sac_lancel', type: 'sac', x: po.x + 1050, y: po.y + 520, emoji: 'üëú', picked: false },
  ];
}

// ---- Telepherique (Grenoble) ----
const grenOrigin = regionOrigin('grenoble');
const TELEPHERIQUE = {
  bottomX: grenOrigin.x + 550, bottomY: grenOrigin.y + 700,
  topX: grenOrigin.x + 550, topY: grenOrigin.y + 250,
};

// T√©l√©ph√©rique ride animation state
const telePheriqueRide = { active: false, progress: 0, direction: 'up', speed: 0.008 };

function startTelePheriqueRide(direction) {
  telePheriqueRide.active = true;
  telePheriqueRide.progress = 0;
  telePheriqueRide.direction = direction;
  gameState.targetX = null;
  gameState.targetY = null;
}

function updateTelePheriqueRide() {
  if (!telePheriqueRide.active) return;
  telePheriqueRide.progress += telePheriqueRide.speed;
  let t = telePheriqueRide.progress;
  if (t >= 1) {
    t = 1;
    telePheriqueRide.active = false;
  }
  const fromX = telePheriqueRide.direction === 'up' ? TELEPHERIQUE.bottomX : TELEPHERIQUE.topX;
  const fromY = telePheriqueRide.direction === 'up' ? TELEPHERIQUE.bottomY : TELEPHERIQUE.topY;
  const toX = telePheriqueRide.direction === 'up' ? TELEPHERIQUE.topX : TELEPHERIQUE.bottomX;
  const toY = telePheriqueRide.direction === 'up' ? TELEPHERIQUE.topY : TELEPHERIQUE.bottomY;
  gameState.playerX = fromX + (toX - fromX) * t;
  gameState.playerY = fromY + (toY - fromY) * t;
}

// ---- Dialogue System ----
let dialogueQueue = [];
let dialogueActive = false;

function showDialogue(speaker, text) {
  dialogueQueue.push({ speaker, text });
  if (!dialogueActive) nextDialogue();
}

function nextDialogue() {
  if (dialogueQueue.length === 0) {
    dialogueActive = false;
    document.getElementById('dialogue-box').style.display = 'none';
    return;
  }
  dialogueActive = true;
  const d = dialogueQueue.shift();
  const box = document.getElementById('dialogue-box');
  const speakerEl = box.querySelector('.speaker');
  if (d.speaker === 'Syst√®me' || d.speaker === 'System') {
    speakerEl.textContent = '';
    speakerEl.style.display = 'none';
  } else {
    speakerEl.textContent = d.speaker;
    speakerEl.style.display = 'block';
  }
  box.querySelector('.text').textContent = d.text;
  box.style.display = 'block';
}

document.getElementById('dialogue-box').addEventListener('click', (e) => {
  e.stopPropagation();
  nextDialogue();
});
document.getElementById('dialogue-box').addEventListener('touchend', (e) => {
  e.stopPropagation();
  e.preventDefault();
  nextDialogue();
});

// ---- Quest System ----
const QUEST_NAMES = {
  carmen:   'üïØÔ∏è Carmen (Cuernavaca)',
  piquis:   'üïØÔ∏è Piquis (Acapulco)',
  lupita:   'üïØÔ∏è Lupita (Paris)',
  valerie:  'üïØÔ∏è Val√©rie (V√©lizy)',
  grenoble: 'üïØÔ∏è G√©raldine (Grenoble)',
  apolline: 'üïØÔ∏è Apolline (Athis-de-l\'Orne)',
};

function updateHUD() {
  if (!gameState) return;
  const hud = document.getElementById('hud');
  if (gameState.allComplete && !endSequenceActive) {
    hud.innerHTML = '<div class="quest-line" style="font-weight:bold;">üéÇ Retourne √† V√©lizy !</div>';
    return;
  }
  if (endSequenceActive) {
    hud.innerHTML = '';
    return;
  }
  const doneCount = Object.values(gameState.quests).filter(q => q.status === 'completed').length;
  const totalCount = Object.keys(gameState.quests).length;
  let html = `<div class="quest-line" style="font-weight:bold;">üéÇ Parle aux personnages avec une bougie (${doneCount}/${totalCount})</div>`;
  hud.innerHTML = html;
}

function completeQuest(questKey) {
  if (!gameState.completedQuests.includes(questKey)) {
    gameState.completedQuests.push(questKey);
  }
  // Teleport quest NPCs to V√©lizy gathering area
  teleportQuestNPCsToVelizy(questKey);
  saveGame();
  checkAllComplete();
}

function teleportQuestNPCsToVelizy(questKey) {
  const vo = regionOrigin('velizy');
  const gatherX = vo.x + 250;
  const gatherY = vo.y + 750;
  const offset = gameState.completedQuests.length * 50;

  const npcMap = {
    carmen: ['carmen'],
    piquis: ['piquis', 'erika'],
    lupita: ['lupita'],
    valerie: ['valerie'],
    grenoble: ['geraldine', 'hugo', 'victor'],
    apolline: ['apolline', 'arthur', 'celeste'],
  };

  const ids = npcMap[questKey] || [];
  ids.forEach((id, i) => {
    const npc = npcs.find(n => n.id === id);
    if (npc) {
      npc.x = gatherX + offset + i * 40;
      npc.y = gatherY + (i % 2) * 30;
      npc.region = 'velizy';
    }
  });
}

function checkAllComplete() {
  const allDone = Object.values(gameState.quests).every(q => q.status === 'completed');
  if (allDone && !gameState.allComplete) {
    gameState.allComplete = true;
    // Teleport ALL NPCs (including G√©rard, Erika, etc.) to the plaza
    const vo = regionOrigin('velizy');
    const gatherX = vo.x + 250;
    const gatherY = vo.y + 750;
    npcs.forEach((npc, i) => {
      npc.x = gatherX + (i % 7) * 45;
      npc.y = gatherY + Math.floor(i / 7) * 35;
      npc.region = 'velizy';
    });
    saveGame();
    // Don't start end sequence yet ‚Äî player must go to V√©lizy and talk to someone
  }
}

// ---- Sculpture Mini-Game ----
const SCULPTURE_PARTS = [
  // Each part has options (text/simple labels), correct index
  { label: 'T√™te', options: ['Chapeau', 'Couronne', 'Casque'], correct: 1 },
  { label: 'Corps', options: ['Cape', 'Robe', 'Armure'], correct: 1 },
  { label: 'Pieds', options: ['Bottes', 'ü©∞', 'Baskets'], correct: 1 },
];

let sculptureSelections = [0, 0, 0];

function openSculptureGame() {
  sculptureSelections = [0, 0, 0];
  const container = document.getElementById('sculpture-container');
  container.innerHTML = '';
  document.getElementById('sculpture-error').textContent = '';

  SCULPTURE_PARTS.forEach((part, i) => {
    const row = document.createElement('div');
    row.className = 'sculpture-row';

    const label = document.createElement('div');
    label.style.cssText = 'color: #c9a96e; font-size: 14px; min-width: 80px; text-align: right; margin-right: 10px;';
    label.textContent = part.label;

    const leftBtn = document.createElement('button');
    leftBtn.className = 'arrow-btn';
    leftBtn.textContent = '‚óÄ';
    leftBtn.onclick = () => changeSculpturePart(i, -1);

    const display = document.createElement('div');
    display.className = 'sculpture-part';
    display.id = `sculpture-part-${i}`;
    display.textContent = part.options[0];

    const rightBtn = document.createElement('button');
    rightBtn.className = 'arrow-btn';
    rightBtn.textContent = '‚ñ∂';
    rightBtn.onclick = () => changeSculpturePart(i, 1);

    row.appendChild(label);
    row.appendChild(leftBtn);
    row.appendChild(display);
    row.appendChild(rightBtn);
    container.appendChild(row);
  });

  document.getElementById('sculpture-game').style.display = 'flex';
}

function changeSculpturePart(partIndex, dir) {
  const part = SCULPTURE_PARTS[partIndex];
  sculptureSelections[partIndex] = (sculptureSelections[partIndex] + dir + part.options.length) % part.options.length;
  document.getElementById(`sculpture-part-${partIndex}`).textContent = part.options[sculptureSelections[partIndex]];
}

document.getElementById('sculpture-validate').addEventListener('click', () => {
  const correct = SCULPTURE_PARTS.every((part, i) => sculptureSelections[i] === part.correct);
  if (correct) {
    document.getElementById('sculpture-game').style.display = 'none';
    gameState.quests.valerie.sculptureComplete = true;
    saveGame();
    showDialogue('Syst√®me', 'Sculpture termin√©e ! Retourne voir Val√©rie !');
  } else {
    document.getElementById('sculpture-error').textContent = "Ce n'est pas tout √† fait √ßa... Essaie encore !";
  }
});

// ---- Region detection ----
function getCurrentRegion(px, py) {
  for (const [key, r] of Object.entries(REGIONS)) {
    const ox = r.col * REGION_W;
    const oy = r.row * REGION_H;
    if (px >= ox && px < ox + REGION_W && py >= oy && py < oy + REGION_H) {
      return key;
    }
  }
  return 'velizy';
}

let lastRegion = 'velizy';
let regionLabelTimer = 0;

function showRegionLabel(name, emoji) {
  const label = document.getElementById('region-label');
  label.textContent = `${emoji} ${name}`;
  label.style.opacity = '1';
  regionLabelTimer = 120; // frames
}

// ---- Save / Load ----
function saveGame() {
  const data = {
    ...gameState,
    npcPositions: npcs.map(n => ({ id: n.id, x: n.x, y: n.y, region: n.region })),
    itemStates: items.map(it => ({ id: it.id, picked: it.picked })),
  };
  localStorage.setItem('elViaje_save', JSON.stringify(data));
}

function loadGame() {
  const raw = localStorage.getItem('elViaje_save');
  if (!raw) return false;
  try {
    const data = JSON.parse(raw);
    gameState = {
      playerX: data.playerX,
      playerY: data.playerY,
      targetX: null,
      targetY: null,
      quests: data.quests,
      talkedTo: data.talkedTo || {},
      completedQuests: data.completedQuests || [],
      allComplete: data.allComplete || false,
      currentRegion: data.currentRegion || 'velizy',
    };
    // Restore NPC positions
    if (data.npcPositions) {
      data.npcPositions.forEach(saved => {
        const npc = npcs.find(n => n.id === saved.id);
        if (npc) {
          npc.x = saved.x;
          npc.y = saved.y;
          npc.region = saved.region;
        }
      });
    }
    // Restore item states
    if (data.itemStates) {
      data.itemStates.forEach(saved => {
        const item = items.find(it => it.id === saved.id);
        if (item) item.picked = saved.picked;
      });
    }
    return true;
  } catch (e) {
    return false;
  }
}

function hasSave() {
  return localStorage.getItem('elViaje_save') !== null;
}

// ---- End Sequence ----
let endSequenceActive = false;
let endSequenceTimer = 0;
let endDancePhase = 0;
const END_DANCE_DURATION = 600; // ~10 seconds at 60fps

function startEndSequence() {
  endSequenceActive = true;
  endSequenceTimer = 0;
  gameState.targetX = null;
  gameState.targetY = null;
  // Center camera on the plaza
  const vo = regionOrigin('velizy');
  gameState.playerX = vo.x + 350;
  gameState.playerY = vo.y + 730;
  showRegionLabel('V√©lizy', 'üéÇ');
}

function updateEndSequence() {
  endSequenceTimer++;
  endDancePhase = endSequenceTimer;
  // Lock camera on the gathering area
  const vo = regionOrigin('velizy');
  camX = vo.x + 350 - canvas.width / 2;
  camY = vo.y + 730 - canvas.height / 2;
  camX = Math.max(0, Math.min(camX, WORLD_W - canvas.width));
  camY = Math.max(0, Math.min(camY, WORLD_H - canvas.height));
  if (endSequenceTimer > END_DANCE_DURATION) {
    endSequenceActive = false;
    document.getElementById('end-screen').style.display = 'flex';
  }
}

// ---- Collision ----
function isWalkable(x, y) {
  // World bounds
  if (x < 10 || x > WORLD_W - 10 || y < 10 || y > WORLD_H - 10) return false;

  // Building collision (simplified ‚Äî only block if inside building rect, leaving some margin)
  for (const b of allBuildings) {
    const margin = 5;
    if (x > b.x + margin && x < b.x + b.w - margin && y > b.y + margin && y < b.y + b.h - margin) {
      // Allow walking in Jardin-Labyrinthe
      if (b.label === 'Jardin-Labyrinthe') continue;
      // Allow walking on Place du village
      if (b.label === 'Place du village') continue;
      // Allow walking in Cour Roland
      if (b.label === 'Cour Roland') continue;
      return false;
    }
  }

  // Maze wall collision
  if (isInMazeWall(x, y)) return false;

  return true;
}

// ---- Input ----
let inputTarget = null;

function handleInput(clientX, clientY) {
  if (dialogueActive || endSequenceActive || telePheriqueRide.active) return;
  if (document.getElementById('sculpture-game').style.display === 'flex') return;

  const worldX = clientX + camX;
  const worldY = clientY + camY;

  // Check NPC click
  for (const npc of npcs) {
    const dx = worldX - npc.x;
    const dy = worldY - npc.y;
    if (Math.sqrt(dx * dx + dy * dy) < NPC_INTERACT_DIST) {
      // Walk to NPC then interact
      gameState.targetX = npc.x;
      gameState.targetY = npc.y;
      gameState.targetNPC = npc;
      return;
    }
  }

  // Check item click
  for (const item of items) {
    if (item.picked) continue;
    const dx = worldX - item.x;
    const dy = worldY - item.y;
    if (Math.sqrt(dx * dx + dy * dy) < ITEM_PICKUP_DIST) {
      gameState.targetX = item.x;
      gameState.targetY = item.y;
      gameState.targetItem = item;
      return;
    }
  }

  // Check Cour Roland click (sculpture mini-game)
  const courRolandX = regionOrigin('velizy').x + 1300;
  const courRolandY = regionOrigin('velizy').y + 565;
  const crdx = worldX - courRolandX;
  const crdy = worldY - courRolandY;
  if (Math.sqrt(crdx * crdx + crdy * crdy) < 100) {
    const q = gameState.quests.valerie;
    if (q.status === 'in_progress' && !q.sculptureComplete) {
      gameState.targetX = courRolandX;
      gameState.targetY = courRolandY;
      gameState.targetCourRoland = true;
      return;
    }
  }

  // Check t√©l√©ph√©rique click (bottom station ‚Üí ride up, or top area ‚Üí ride down)
  if (!telePheriqueRide.active) {
    const tdx = worldX - TELEPHERIQUE.bottomX;
    const tdy = worldY - TELEPHERIQUE.bottomY;
    if (Math.sqrt(tdx * tdx + tdy * tdy) < 80) {
      startTelePheriqueRide('up');
      return;
    }
    const tdx2 = worldX - TELEPHERIQUE.topX;
    const tdy2 = worldY - TELEPHERIQUE.topY;
    if (Math.sqrt(tdx2 * tdx2 + tdy2 * tdy2) < 80) {
      startTelePheriqueRide('down');
      return;
    }
  }

  // Just move
  gameState.targetX = worldX;
  gameState.targetY = worldY;
  gameState.targetNPC = null;
  gameState.targetItem = null;
}

canvas.addEventListener('click', (e) => {
  // Close dialogue if active when clicking on canvas (i.e. outside the dialogue box)
  if (dialogueActive) {
    dialogueQueue = [];
    dialogueActive = false;
    document.getElementById('dialogue-box').style.display = 'none';
    return;
  }
  handleInput(e.clientX, e.clientY);
});
canvas.addEventListener('touchstart', (e) => {
  e.preventDefault();
  if (dialogueActive) {
    dialogueQueue = [];
    dialogueActive = false;
    document.getElementById('dialogue-box').style.display = 'none';
    return;
  }
  const touch = e.touches[0];
  handleInput(touch.clientX, touch.clientY);
}, { passive: false });

// ---- Update ----
function update() {
  if (!gameState) return;
  if (endSequenceActive) { updateEndSequence(); return; }
  if (telePheriqueRide.active) { updateTelePheriqueRide(); updateCamera(); return; }
  if (dialogueActive) return;
  if (document.getElementById('sculpture-game').style.display === 'flex') return;

  // Move player toward target
  if (gameState.targetX !== null && gameState.targetY !== null) {
    const dx = gameState.targetX - gameState.playerX;
    const dy = gameState.targetY - gameState.playerY;
    const dist = Math.sqrt(dx * dx + dy * dy);

    if (dist < 5) {
      gameState.targetX = null;
      gameState.targetY = null;

      // Interact with NPC
      if (gameState.targetNPC) {
        const npc = gameState.targetNPC;
        gameState.targetNPC = null;
        // If all quests complete and we're in V√©lizy, trigger end dance
        if (gameState.allComplete && getCurrentRegion(gameState.playerX, gameState.playerY) === 'velizy') {
          startEndSequence();
          return;
        }
        const text = npc.dialogue();
        if (text) showDialogue(npc.name, text);
        gameState.talkedTo[npc.id] = true;
        saveGame();
        updateHUD();
      }
      // Arrive at Cour Roland
      if (gameState.targetCourRoland) {
        gameState.targetCourRoland = false;
        openSculptureGame();
      }
      // Pick up item
      if (gameState.targetItem) {
        const item = gameState.targetItem;
        gameState.targetItem = null;
        pickupItem(item);
      }
    } else {
      const moveX = (dx / dist) * PLAYER_SPEED;
      const moveY = (dy / dist) * PLAYER_SPEED;
      const newX = gameState.playerX + moveX;
      const newY = gameState.playerY + moveY;
      if (isWalkable(newX, newY)) {
        gameState.playerX = newX;
        gameState.playerY = newY;
      } else if (isWalkable(newX, gameState.playerY)) {
        gameState.playerX = newX;
      } else if (isWalkable(gameState.playerX, newY)) {
        gameState.playerY = newY;
      } else {
        gameState.targetX = null;
        gameState.targetY = null;
      }
    }
  }

  // Region detection
  const region = getCurrentRegion(gameState.playerX, gameState.playerY);
  if (region !== lastRegion) {
    lastRegion = region;
    gameState.currentRegion = region;
    const r = REGIONS[region];
    showRegionLabel(r.name, r.emoji);
  }

  // Region label fade
  if (regionLabelTimer > 0) {
    regionLabelTimer--;
    if (regionLabelTimer === 0) {
      document.getElementById('region-label').style.opacity = '0';
    }
  }

  // Auto-pickup items when walking near
  for (const item of items) {
    if (item.picked) continue;
    const dx = gameState.playerX - item.x;
    const dy = gameState.playerY - item.y;
    if (Math.sqrt(dx * dx + dy * dy) < ITEM_PICKUP_DIST) {
      pickupItem(item);
    }
  }

  updateCamera();
}

function pickupItem(item) {
  if (item.picked) return;
  item.picked = true;

  if (item.type === 'tortilla') {
    gameState.quests.carmen.tortillas++;
    showDialogue('Syst√®me', `ü´ì Tortilla trouv√©e ! (${gameState.quests.carmen.tortillas}/3)`);
  } else if (item.type === 'sac') {
    gameState.quests.lupita.hasSac = true;
    showDialogue('Syst√®me', 'üëú Sac Lancel trouv√© !');
  }
  saveGame();
  updateHUD();
}

// ---- Rendering ----
function drawGround() {
  // Draw each region with its color
  for (const [key, r] of Object.entries(REGIONS)) {
    const ox = r.col * REGION_W;
    const oy = r.row * REGION_H;
    const sx = ox - camX;
    const sy = oy - camY;

    // Skip if off-screen
    if (sx + REGION_W < 0 || sx > canvas.width || sy + REGION_H < 0 || sy > canvas.height) continue;

    // Ground
    ctx.fillStyle = r.color;
    ctx.fillRect(sx, sy, REGION_W, REGION_H);

    // Ground texture - grass-like variation
    const startTileX = Math.max(0, Math.floor(-sx / TILE));
    const endTileX = Math.min(40, Math.ceil((canvas.width - sx) / TILE));
    const startTileY = Math.max(0, Math.floor(-sy / TILE));
    const endTileY = Math.min(30, Math.ceil((canvas.height - sy) / TILE));
    for (let tx = startTileX; tx < endTileX; tx++) {
      for (let ty = startTileY; ty < endTileY; ty++) {
        const hash = ((tx * 7 + ty * 13 + r.col * 31 + r.row * 53) % 17) / 17;
        if (hash < 0.3) {
          ctx.fillStyle = 'rgba(0,0,0,0.04)';
          ctx.fillRect(sx + tx * TILE, sy + ty * TILE, TILE, TILE);
        } else if (hash > 0.85) {
          ctx.fillStyle = 'rgba(255,255,255,0.03)';
          ctx.fillRect(sx + tx * TILE, sy + ty * TILE, TILE, TILE);
        }
      }
    }

    // Draw paths/roads per region
    ctx.strokeStyle = 'rgba(160,140,110,0.5)';
    ctx.lineWidth = 18;
    ctx.setLineDash([]);
    if (key === 'velizy') {
      // Main road through town
      ctx.strokeStyle = '#8a7a6a';
      ctx.lineWidth = 20;
      ctx.beginPath();
      ctx.moveTo(sx + 100, sy + 400);
      ctx.lineTo(sx + 1400, sy + 400);
      ctx.stroke();
      // Cross road
      ctx.beginPath();
      ctx.moveTo(sx + 700, sy + 50);
      ctx.lineTo(sx + 700, sy + 1100);
      ctx.stroke();
      // Path borders
      ctx.strokeStyle = '#6a5a4a';
      ctx.lineWidth = 1;
      ctx.setLineDash([4, 4]);
      ctx.beginPath();
      ctx.moveTo(sx + 100, sy + 390);
      ctx.lineTo(sx + 1400, sy + 390);
      ctx.moveTo(sx + 100, sy + 410);
      ctx.lineTo(sx + 1400, sy + 410);
      ctx.stroke();
      ctx.setLineDash([]);
    } else if (key === 'cuernavaca') {
      // Winding dusty road
      ctx.strokeStyle = '#a08a60';
      ctx.lineWidth = 22;
      ctx.beginPath();
      ctx.moveTo(sx, sy + 500);
      ctx.quadraticCurveTo(sx + 400, sy + 350, sx + 800, sy + 500);
      ctx.quadraticCurveTo(sx + 1200, sy + 650, sx + 1600, sy + 500);
      ctx.stroke();
    } else if (key === 'acapulco') {
      // Beach boardwalk
      ctx.strokeStyle = '#c0a870';
      ctx.lineWidth = 16;
      ctx.beginPath();
      ctx.moveTo(sx + 50, sy + 600);
      ctx.lineTo(sx + 900, sy + 600);
      ctx.stroke();
    } else if (key === 'paris') {
      // Boulevard
      ctx.strokeStyle = '#5a5a6a';
      ctx.lineWidth = 24;
      ctx.beginPath();
      ctx.moveTo(sx + 50, sy + 500);
      ctx.lineTo(sx + 1500, sy + 500);
      ctx.stroke();
      // Cobblestone hint
      ctx.strokeStyle = '#6a6a7a';
      ctx.lineWidth = 1;
      for (let cx = 60; cx < 1500; cx += 12) {
        for (let cy = 490; cy < 510; cy += 8) {
          ctx.strokeRect(sx + cx + ((cy % 16 === 0) ? 6 : 0), sy + cy, 10, 6);
        }
      }
    } else if (key === 'athis') {
      // Dirt path
      ctx.strokeStyle = '#8a7a50';
      ctx.lineWidth = 14;
      ctx.beginPath();
      ctx.moveTo(sx + 50, sy + 400);
      ctx.lineTo(sx + 650, sy + 400);
      ctx.stroke();
    }

    // Region-specific ground details
    if (key === 'velizy') {
      // Grass tufts
      ctx.fillStyle = 'rgba(80,140,60,0.25)';
      for (let g = 0; g < 40; g++) {
        const gx = sx + ((g * 137 + 29) % 1600);
        const gy = sy + ((g * 211 + 73) % 1200);
        ctx.beginPath();
        ctx.moveTo(gx, gy);
        ctx.lineTo(gx - 3, gy - 8);
        ctx.lineTo(gx + 1, gy - 6);
        ctx.lineTo(gx + 4, gy - 10);
        ctx.lineTo(gx + 3, gy);
        ctx.fill();
      }
    } else if (key === 'cuernavaca') {
      // Colorful ground patches (terracotta tiles feel)
      ctx.globalAlpha = 0.08;
      for (let p = 0; p < 15; p++) {
        const px2 = sx + ((p * 179 + 41) % 1500);
        const py2 = sy + ((p * 233 + 67) % 1100);
        ctx.fillStyle = ['#e06030', '#d0a040', '#c07040'][p % 3];
        ctx.fillRect(px2, py2, 60, 60);
      }
      ctx.globalAlpha = 1;
    } else if (key === 'acapulco') {
      // Sunset gradient at top
      const sunGrad = ctx.createLinearGradient(sx, sy, sx, sy + 200);
      sunGrad.addColorStop(0, 'rgba(240,160,80,0.15)');
      sunGrad.addColorStop(1, 'transparent');
      ctx.fillStyle = sunGrad;
      ctx.fillRect(sx, sy, REGION_W, 200);
    } else if (key === 'paris') {
      // Seine river through bottom
      ctx.fillStyle = '#4a7aa0';
      ctx.beginPath();
      ctx.moveTo(sx, sy + 800);
      ctx.quadraticCurveTo(sx + 400, sy + 780, sx + 800, sy + 810);
      ctx.quadraticCurveTo(sx + 1200, sy + 840, sx + 1600, sy + 800);
      ctx.lineTo(sx + 1600, sy + 840);
      ctx.quadraticCurveTo(sx + 1200, sy + 880, sx + 800, sy + 850);
      ctx.quadraticCurveTo(sx + 400, sy + 820, sx, sy + 840);
      ctx.closePath();
      ctx.fill();
      // Seine ripples
      ctx.strokeStyle = 'rgba(255,255,255,0.15)';
      ctx.lineWidth = 1;
      for (let rp = 0; rp < 8; rp++) {
        const ry2 = sy + 805 + rp * 4;
        ctx.beginPath();
        for (let rx2 = 0; rx2 < 1600; rx2 += 20) {
          const wv = Math.sin((rx2 + Date.now() * 0.001 + rp * 50) * 0.08) * 3;
          if (rx2 === 0) ctx.moveTo(sx + rx2, ry2 + wv);
          else ctx.lineTo(sx + rx2, ry2 + wv);
        }
        ctx.stroke();
      }
    } else if (key === 'athis') {
      // Rolling hill contours
      ctx.strokeStyle = 'rgba(80,120,60,0.2)';
      ctx.lineWidth = 2;
      for (let h = 0; h < 4; h++) {
        ctx.beginPath();
        ctx.moveTo(sx, sy + 200 + h * 250);
        ctx.quadraticCurveTo(sx + 400, sy + 150 + h * 250, sx + 800, sy + 220 + h * 250);
        ctx.quadraticCurveTo(sx + 1200, sy + 170 + h * 250, sx + 1600, sy + 210 + h * 250);
        ctx.stroke();
      }
    }

    // Clouds (all regions)
    ctx.fillStyle = 'rgba(255,255,255,0.08)';
    for (let cl = 0; cl < 5; cl++) {
      const cx2 = sx + ((cl * 317 + r.col * 500 + 100) % 1400);
      const cy2 = sy + 30 + ((cl * 131 + r.row * 200) % 150);
      ctx.beginPath();
      ctx.ellipse(cx2, cy2, 40 + cl * 5, 12 + cl * 2, 0, 0, Math.PI * 2);
      ctx.fill();
      ctx.beginPath();
      ctx.ellipse(cx2 + 25, cy2 - 5, 25, 10, 0, 0, Math.PI * 2);
      ctx.fill();
    }

    // Region border (subtle)
    ctx.strokeStyle = 'rgba(255,255,255,0.15)';
    ctx.lineWidth = 2;
    ctx.strokeRect(sx, sy, REGION_W, REGION_H);

    // Region name in corner
    ctx.fillStyle = 'rgba(255,255,255,0.5)';
    ctx.font = 'bold 18px Georgia';
    ctx.fillText(`${r.emoji} ${r.name}`, sx + 10, sy + 25);

    // Directional signposts at borders
    ctx.textAlign = 'center';
    function drawSignpost(x, y, text, arrowDir) {
      // Post
      ctx.fillStyle = '#5a4a2a';
      ctx.fillRect(x - 2, y - 5, 4, 18);
      // Sign board
      ctx.fillStyle = '#8a6a3a';
      const tw = ctx.measureText(text).width + 16;
      ctx.fillRect(x - tw/2, y - 16, tw, 16);
      ctx.fillStyle = '#fff';
      ctx.font = 'bold 10px Georgia';
      ctx.fillText(arrowDir + ' ' + text, x, y - 5);
    }
    ctx.font = 'bold 10px Georgia';
    if (r.col < 2) {
      const rightRegion = Object.values(REGIONS).find(rr => rr.col === r.col + 1 && rr.row === r.row);
      if (rightRegion) drawSignpost(sx + REGION_W - 50, sy + REGION_H / 2, rightRegion.name, '‚Üí');
    }
    if (r.col > 0) {
      const leftRegion = Object.values(REGIONS).find(rr => rr.col === r.col - 1 && rr.row === r.row);
      if (leftRegion) drawSignpost(sx + 50, sy + REGION_H / 2, leftRegion.name, '‚Üê');
    }
    if (r.row < 1) {
      const bottomRegion = Object.values(REGIONS).find(rr => rr.col === r.col && rr.row === r.row + 1);
      if (bottomRegion) drawSignpost(sx + REGION_W / 2, sy + REGION_H - 20, bottomRegion.name, '‚Üì');
    }
    if (r.row > 0) {
      const topRegion = Object.values(REGIONS).find(rr => rr.col === r.col && rr.row === r.row - 1);
      if (topRegion) drawSignpost(sx + REGION_W / 2, sy + 35, topRegion.name, '‚Üë');
    }
    ctx.textAlign = 'left';

    // Special: beach sand zone and ocean in Acapulco (right side)
    if (key === 'acapulco') {
      // Sandy beach strip
      ctx.fillStyle = '#e8d4a0';
      ctx.fillRect(sx + REGION_W - 400, sy, 100, REGION_H);
      // Ocean
      ctx.fillStyle = '#2070a0';
      ctx.fillRect(sx + REGION_W - 300, sy, 300, REGION_H);
      // Waves
      ctx.strokeStyle = 'rgba(255,255,255,0.3)';
      ctx.lineWidth = 2;
      for (let wy = 0; wy < REGION_H; wy += 40) {
        ctx.beginPath();
        for (let wx = REGION_W - 300; wx < REGION_W; wx += 10) {
          const waveY = sy + wy + Math.sin((wx + Date.now() * 0.002) * 0.1) * 5;
          if (wx === REGION_W - 300) ctx.moveTo(sx + wx, waveY);
          else ctx.lineTo(sx + wx, waveY);
        }
        ctx.stroke();
      }
      // Sailboats on the ocean
      for (let sb = 0; sb < 3; sb++) {
        const bx = sx + REGION_W - 250 + sb * 80;
        const by = sy + 200 + sb * 300 + Math.sin(Date.now() * 0.0005 + sb * 2) * 8;
        // Hull
        ctx.fillStyle = '#c0503a';
        ctx.beginPath();
        ctx.moveTo(bx - 12, by);
        ctx.lineTo(bx + 12, by);
        ctx.lineTo(bx + 8, by + 6);
        ctx.lineTo(bx - 8, by + 6);
        ctx.closePath();
        ctx.fill();
        // Sail
        ctx.fillStyle = '#fff';
        ctx.beginPath();
        ctx.moveTo(bx, by - 20);
        ctx.lineTo(bx + 10, by);
        ctx.lineTo(bx, by);
        ctx.closePath();
        ctx.fill();
        // Mast
        ctx.strokeStyle = '#4a3020';
        ctx.lineWidth = 1;
        ctx.beginPath();
        ctx.moveTo(bx, by);
        ctx.lineTo(bx, by - 22);
        ctx.stroke();
      }
      // Foam at shore edge
      ctx.fillStyle = 'rgba(255,255,255,0.4)';
      for (let fy = 0; fy < REGION_H; fy += 20) {
        const fx = REGION_W - 300 + Math.sin((fy * 0.1 + Date.now() * 0.002)) * 5;
        ctx.beginPath();
        ctx.ellipse(sx + fx, sy + fy, 8, 3, 0, 0, Math.PI * 2);
        ctx.fill();
      }
    }

    // Special: mountain gradient and peaks in Grenoble
    if (key === 'grenoble') {
      const grad = ctx.createLinearGradient(sx, sy, sx, sy + REGION_H * 0.6);
      grad.addColorStop(0, '#3a4a2a');
      grad.addColorStop(1, 'transparent');
      ctx.fillStyle = grad;
      ctx.fillRect(sx, sy, REGION_W, REGION_H * 0.6);

      // Mountain peaks silhouette in background
      ctx.fillStyle = '#3a5a3a';
      ctx.beginPath();
      ctx.moveTo(sx, sy + 200);
      ctx.lineTo(sx + 150, sy + 40);
      ctx.lineTo(sx + 300, sy + 160);
      ctx.lineTo(sx + 500, sy + 20);
      ctx.lineTo(sx + 700, sy + 130);
      ctx.lineTo(sx + 900, sy + 10);
      ctx.lineTo(sx + 1100, sy + 100);
      ctx.lineTo(sx + 1300, sy + 30);
      ctx.lineTo(sx + 1600, sy + 150);
      ctx.lineTo(sx + 1600, sy + 300);
      ctx.lineTo(sx, sy + 300);
      ctx.closePath();
      ctx.fill();

      // Snow caps
      ctx.fillStyle = 'rgba(240,245,255,0.5)';
      ctx.beginPath();
      ctx.moveTo(sx + 140, sy + 50);
      ctx.lineTo(sx + 150, sy + 40);
      ctx.lineTo(sx + 160, sy + 50);
      ctx.closePath();
      ctx.fill();
      ctx.beginPath();
      ctx.moveTo(sx + 485, sy + 30);
      ctx.lineTo(sx + 500, sy + 20);
      ctx.lineTo(sx + 515, sy + 35);
      ctx.closePath();
      ctx.fill();
      ctx.beginPath();
      ctx.moveTo(sx + 885, sy + 20);
      ctx.lineTo(sx + 900, sy + 10);
      ctx.lineTo(sx + 920, sy + 25);
      ctx.closePath();
      ctx.fill();
      ctx.beginPath();
      ctx.moveTo(sx + 1285, sy + 40);
      ctx.lineTo(sx + 1300, sy + 30);
      ctx.lineTo(sx + 1315, sy + 45);
      ctx.closePath();
      ctx.fill();

      // River/stream through valley
      ctx.strokeStyle = '#4a8ab0';
      ctx.lineWidth = 8;
      ctx.beginPath();
      ctx.moveTo(sx + 100, sy + 1100);
      ctx.quadraticCurveTo(sx + 400, sy + 950, sx + 300, sy + 800);
      ctx.quadraticCurveTo(sx + 200, sy + 700, sx + 400, sy + 650);
      ctx.stroke();
      ctx.strokeStyle = 'rgba(255,255,255,0.2)';
      ctx.lineWidth = 2;
      ctx.stroke();

      // Mountain path (zigzag line)
      ctx.strokeStyle = '#8a7a6a';
      ctx.lineWidth = 30;
      ctx.setLineDash([]);
      ctx.beginPath();
      ctx.moveTo(sx + 550, sy + 700);
      ctx.lineTo(sx + 400, sy + 550);
      ctx.lineTo(sx + 650, sy + 450);
      ctx.lineTo(sx + 350, sy + 350);
      ctx.lineTo(sx + 600, sy + 250);
      ctx.stroke();

      // T√©l√©ph√©rique cable
      ctx.strokeStyle = '#555';
      ctx.lineWidth = 3;
      ctx.beginPath();
      ctx.moveTo(sx + 550, sy + 700);
      ctx.lineTo(sx + 550, sy + 250);
      ctx.stroke();

      // Egg cabins
      const eggY = sy + 450 + Math.sin(Date.now() * 0.001) * 20;
      ctx.fillStyle = '#e8d5b7';
      ctx.beginPath();
      ctx.ellipse(sx + 550, eggY, 15, 20, 0, 0, Math.PI * 2);
      ctx.fill();
      ctx.strokeStyle = '#8a7a6a';
      ctx.lineWidth = 2;
      ctx.stroke();
    }
  }
}

function drawBuildings() {
  for (const b of allBuildings) {
    const sx = b.x - camX;
    const sy = b.y - camY;
    if (sx + b.w < 0 || sx > canvas.width || sy + b.h < 0 || sy > canvas.height) continue;

    const btype = b.type || 'default';

    // Shadow
    ctx.fillStyle = 'rgba(0,0,0,0.15)';
    ctx.fillRect(sx + 4, sy + 4, b.w, b.h);

    // Main building body
    ctx.fillStyle = b.color;
    ctx.fillRect(sx, sy, b.w, b.h);

    // Building details based on type
    if (btype === 'house' || btype === 'shop' || btype === 'parisian' || btype === 'school' || btype === 'mexican' || btype === 'hotel' || btype === 'farm') {
      // Roof
      ctx.fillStyle = darkenColor(b.color, 0.3);
      ctx.fillRect(sx - 4, sy - 8, b.w + 8, 12);

      // Windows
      ctx.fillStyle = '#c0d8f0';
      const winCols = Math.floor(b.w / 40);
      const winRows = Math.floor(b.h / 45);
      for (let wr = 0; wr < winRows; wr++) {
        for (let wc = 0; wc < winCols; wc++) {
          const wx = sx + 15 + wc * (b.w - 20) / Math.max(winCols, 1);
          const wy = sy + 15 + wr * 35;
          ctx.fillRect(wx, wy, 14, 12);
          // Window frame
          ctx.strokeStyle = 'rgba(0,0,0,0.3)';
          ctx.lineWidth = 1;
          ctx.strokeRect(wx, wy, 14, 12);
          // Cross bar
          ctx.beginPath();
          ctx.moveTo(wx + 7, wy);
          ctx.lineTo(wx + 7, wy + 12);
          ctx.moveTo(wx, wy + 6);
          ctx.lineTo(wx + 14, wy + 6);
          ctx.stroke();
        }
      }

      // Door
      ctx.fillStyle = darkenColor(b.color, 0.4);
      const doorW = 14, doorH = 20;
      ctx.fillRect(sx + b.w / 2 - doorW / 2, sy + b.h - doorH, doorW, doorH);
      // Door knob
      ctx.fillStyle = '#c9a96e';
      ctx.beginPath();
      ctx.arc(sx + b.w / 2 + 3, sy + b.h - doorH / 2, 2, 0, Math.PI * 2);
      ctx.fill();
    }

    if (btype === 'eiffel') {
      // Eiffel Tower shape
      ctx.fillStyle = '#6a6a6a';
      ctx.beginPath();
      ctx.moveTo(sx + b.w / 2, sy);
      ctx.lineTo(sx - 10, sy + b.h);
      ctx.lineTo(sx + b.w + 10, sy + b.h);
      ctx.closePath();
      ctx.fill();
      // Cross beams
      ctx.strokeStyle = '#5a5a5a';
      ctx.lineWidth = 2;
      for (let ly = 0; ly < 4; ly++) {
        const yy = sy + 30 + ly * 40;
        ctx.beginPath();
        ctx.moveTo(sx + b.w / 2 - 20 - ly * 5, yy);
        ctx.lineTo(sx + b.w / 2 + 20 + ly * 5, yy);
        ctx.stroke();
      }
    }

    if (btype === 'mexican') {
      // Colorful awning
      const awningColors = ['#e04040', '#40a040', '#e0c020', '#e06020'];
      const stripeW = Math.floor(b.w / awningColors.length);
      for (let s = 0; s < awningColors.length; s++) {
        ctx.fillStyle = awningColors[s];
        ctx.fillRect(sx + s * stripeW, sy + b.h - 3, stripeW, 5);
      }
    }

    if (btype === 'hotel') {
      // Balcony lines
      ctx.strokeStyle = 'rgba(0,0,0,0.2)';
      ctx.lineWidth = 1;
      for (let fl = 1; fl < 3; fl++) {
        const flY = sy + fl * Math.floor(b.h / 3);
        ctx.beginPath();
        ctx.moveTo(sx, flY);
        ctx.lineTo(sx + b.w, flY);
        ctx.stroke();
        // Balcony rail
        ctx.fillStyle = '#c0b0a0';
        ctx.fillRect(sx, flY, b.w, 3);
      }
    }

    if (btype === 'castle') {
      // Bastille: add battlements
      ctx.fillStyle = darkenColor(b.color, 0.2);
      for (let bt = 0; bt < Math.floor(b.w / 20); bt++) {
        ctx.fillRect(sx + bt * 20, sy - 10, 12, 10);
      }
    }

    if (btype === 'park' || btype === 'garden') {
      // Don't draw as a solid block - just outline
      ctx.strokeStyle = 'rgba(0,0,0,0.2)';
      ctx.lineWidth = 1;
      ctx.setLineDash([5, 5]);
      ctx.strokeRect(sx, sy, b.w, b.h);
      ctx.setLineDash([]);
    } else {
      // Outline
      ctx.strokeStyle = 'rgba(0,0,0,0.4)';
      ctx.lineWidth = 2;
      ctx.strokeRect(sx, sy, b.w, b.h);
    }

    // Label
    ctx.fillStyle = b.labelColor;
    ctx.font = 'bold 12px Georgia';
    ctx.textAlign = 'center';
    if (btype === 'park' || btype === 'garden' || btype === 'plaza') {
      ctx.fillText(b.label, sx + b.w / 2, sy + b.h / 2 + 5);
    } else {
      ctx.fillText(b.label, sx + b.w / 2, sy - 14);
    }
    ctx.textAlign = 'left';
  }
}

function darkenColor(hex, amount) {
  const r = Math.max(0, parseInt(hex.slice(1,3), 16) - Math.floor(255 * amount));
  const g = Math.max(0, parseInt(hex.slice(3,5), 16) - Math.floor(255 * amount));
  const bl = Math.max(0, parseInt(hex.slice(5,7), 16) - Math.floor(255 * amount));
  return `rgb(${r},${g},${bl})`;
}

function drawMaze() {
  for (let r = 0; r < MAZE_ROWS; r++) {
    for (let c = 0; c < MAZE_COLS; c++) {
      const wx = MAZE_ORIGIN_X + c * MAZE_CELL;
      const wy = MAZE_ORIGIN_Y + r * MAZE_CELL;
      const sx = wx - camX;
      const sy = wy - camY;

      if (sx + MAZE_CELL < 0 || sx > canvas.width || sy + MAZE_CELL < 0 || sy > canvas.height) continue;

      if (MAZE_GRID[r][c] === 1) {
        // Hedge wall
        ctx.fillStyle = '#2a5a1a';
        ctx.fillRect(sx, sy, MAZE_CELL, MAZE_CELL);
        ctx.strokeStyle = '#1a4a0a';
        ctx.lineWidth = 1;
        ctx.strokeRect(sx, sy, MAZE_CELL, MAZE_CELL);
        // Leaf texture
        ctx.fillStyle = '#3a7a2a';
        ctx.beginPath();
        ctx.arc(sx + 15, sy + 15, 8, 0, Math.PI * 2);
        ctx.fill();
        ctx.beginPath();
        ctx.arc(sx + 35, sy + 25, 6, 0, Math.PI * 2);
        ctx.fill();
      }
    }
  }

  // Maze decorations
  for (const d of mazeDecos) {
    const sx = d.x - camX;
    const sy = d.y - camY;
    if (sx < -30 || sx > canvas.width + 30 || sy < -30 || sy > canvas.height + 30) continue;
    ctx.font = '20px serif';
    ctx.textAlign = 'center';
    let emoji = 'ü•ï';
    if (d.type === 'camembert') emoji = 'üßÄ';
    else if (d.type === 'cow') emoji = 'üêÑ';
    else if (d.type === 'veggie') emoji = 'ü•¨';
    ctx.fillText(emoji, sx, sy + 6);
    ctx.textAlign = 'left';
  }
}

function drawDecorations() {
  for (const d of allDecorations) {
    const sx = d.x - camX;
    const sy = d.y - camY;
    if (sx < -50 || sx > canvas.width + 50 || sy < -50 || sy > canvas.height + 50) continue;

    ctx.textAlign = 'center';

    switch (d.type) {
      case 'tree':
        // Draw a tree with trunk and canopy
        ctx.fillStyle = '#5a3a1a';
        ctx.fillRect(sx - 3, sy - 5, 6, 16);
        ctx.fillStyle = '#3a8a2a';
        ctx.beginPath();
        ctx.arc(sx, sy - 12, 12, 0, Math.PI * 2);
        ctx.fill();
        ctx.fillStyle = '#4a9a3a';
        ctx.beginPath();
        ctx.arc(sx - 5, sy - 8, 8, 0, Math.PI * 2);
        ctx.fill();
        ctx.beginPath();
        ctx.arc(sx + 6, sy - 10, 7, 0, Math.PI * 2);
        ctx.fill();
        break;
      case 'pine':
        // Pine tree (triangle)
        ctx.fillStyle = '#4a3010';
        ctx.fillRect(sx - 3, sy, 6, 14);
        ctx.fillStyle = '#2a6a2a';
        ctx.beginPath();
        ctx.moveTo(sx, sy - 22);
        ctx.lineTo(sx - 12, sy + 2);
        ctx.lineTo(sx + 12, sy + 2);
        ctx.closePath();
        ctx.fill();
        ctx.fillStyle = '#1a5a1a';
        ctx.beginPath();
        ctx.moveTo(sx, sy - 16);
        ctx.lineTo(sx - 10, sy + 6);
        ctx.lineTo(sx + 10, sy + 6);
        ctx.closePath();
        ctx.fill();
        break;
      case 'plane_tree':
        // Tall Parisian plane tree
        ctx.fillStyle = '#6a5a3a';
        ctx.fillRect(sx - 3, sy - 8, 6, 22);
        ctx.fillStyle = '#5a9a3a';
        ctx.beginPath();
        ctx.arc(sx, sy - 16, 14, 0, Math.PI * 2);
        ctx.fill();
        ctx.fillStyle = '#4a8a2a';
        ctx.beginPath();
        ctx.arc(sx - 7, sy - 12, 9, 0, Math.PI * 2);
        ctx.fill();
        break;
      case 'cactus':
        // Draw a cactus shape
        ctx.fillStyle = '#2a7a2a';
        ctx.fillRect(sx - 4, sy - 10, 8, 24);
        ctx.fillRect(sx - 12, sy - 6, 10, 6);
        ctx.fillRect(sx - 12, sy - 12, 4, 10);
        ctx.fillRect(sx + 4, sy - 2, 8, 6);
        ctx.fillRect(sx + 8, sy - 8, 4, 10);
        ctx.fillStyle = '#3a9a3a';
        ctx.fillRect(sx - 3, sy - 9, 6, 22);
        break;
      case 'palm':
        // Palm tree with trunk and fronds
        ctx.fillStyle = '#8a6a3a';
        ctx.fillRect(sx - 3, sy - 5, 6, 22);
        // Fronds
        ctx.strokeStyle = '#2a8a2a';
        ctx.lineWidth = 3;
        for (let a = 0; a < 5; a++) {
          const angle = (a / 5) * Math.PI * 2 - Math.PI / 2;
          ctx.beginPath();
          ctx.moveTo(sx, sy - 10);
          ctx.quadraticCurveTo(
            sx + Math.cos(angle) * 18, sy - 10 + Math.sin(angle) * 12,
            sx + Math.cos(angle) * 22, sy - 5 + Math.sin(angle) * 18
          );
          ctx.stroke();
        }
        // Coconuts
        ctx.fillStyle = '#6a4a2a';
        ctx.beginPath();
        ctx.arc(sx - 3, sy - 8, 3, 0, Math.PI * 2);
        ctx.arc(sx + 3, sy - 9, 3, 0, Math.PI * 2);
        ctx.fill();
        break;
      case 'rock':
        ctx.fillStyle = '#7a7a7a';
        ctx.beginPath();
        ctx.ellipse(sx, sy, 10, 7, 0, 0, Math.PI * 2);
        ctx.fill();
        ctx.fillStyle = '#9a9a9a';
        ctx.beginPath();
        ctx.ellipse(sx - 2, sy - 2, 6, 4, 0.3, 0, Math.PI * 2);
        ctx.fill();
        break;
      case 'cow':
        ctx.font = '22px serif';
        ctx.fillText('üêÑ', sx, sy);
        break;
      case 'flower':
        // Small flower cluster
        const flowerColors = ['#e05070', '#e0a030', '#d040d0', '#f06080'];
        ctx.fillStyle = flowerColors[Math.floor((d.x * 7 + d.y * 3) % flowerColors.length)];
        ctx.beginPath();
        ctx.arc(sx, sy, 4, 0, Math.PI * 2);
        ctx.fill();
        ctx.fillStyle = '#ffd700';
        ctx.beginPath();
        ctx.arc(sx, sy, 2, 0, Math.PI * 2);
        ctx.fill();
        // Stem
        ctx.strokeStyle = '#3a7a2a';
        ctx.lineWidth = 1;
        ctx.beginPath();
        ctx.moveTo(sx, sy + 3);
        ctx.lineTo(sx, sy + 8);
        ctx.stroke();
        break;
      case 'wildflower':
        // Wild flower (simpler, scattered)
        const wfColors = ['#c040a0', '#f0e040', '#40a0f0', '#f07030', '#a040f0'];
        ctx.fillStyle = wfColors[Math.floor((d.x * 3 + d.y * 11) % wfColors.length)];
        ctx.beginPath();
        ctx.arc(sx - 2, sy, 3, 0, Math.PI * 2);
        ctx.fill();
        ctx.fillStyle = wfColors[Math.floor((d.x * 7 + d.y * 5) % wfColors.length)];
        ctx.beginPath();
        ctx.arc(sx + 3, sy + 2, 2.5, 0, Math.PI * 2);
        ctx.fill();
        break;
      case 'bush':
        ctx.fillStyle = '#3a7a3a';
        ctx.beginPath();
        ctx.arc(sx, sy, 8, 0, Math.PI * 2);
        ctx.fill();
        ctx.fillStyle = '#4a9a4a';
        ctx.beginPath();
        ctx.arc(sx + 4, sy - 3, 6, 0, Math.PI * 2);
        ctx.fill();
        break;
      case 'bench':
        // Park bench
        ctx.fillStyle = '#6a4a2a';
        ctx.fillRect(sx - 12, sy, 24, 4);
        ctx.fillRect(sx - 12, sy - 6, 24, 3);
        ctx.fillStyle = '#3a3a3a';
        ctx.fillRect(sx - 10, sy + 3, 3, 6);
        ctx.fillRect(sx + 8, sy + 3, 3, 6);
        break;
      case 'lamp':
        // Street lamp
        ctx.fillStyle = '#4a4a4a';
        ctx.fillRect(sx - 1, sy - 15, 3, 24);
        ctx.fillStyle = '#f0e070';
        ctx.beginPath();
        ctx.arc(sx + 1, sy - 17, 4, 0, Math.PI * 2);
        ctx.fill();
        ctx.globalAlpha = 0.15;
        ctx.fillStyle = '#f0e070';
        ctx.beginPath();
        ctx.arc(sx + 1, sy - 17, 12, 0, Math.PI * 2);
        ctx.fill();
        ctx.globalAlpha = 1;
        break;
      case 'paris_lamp':
        // Ornate Parisian lamp
        ctx.fillStyle = '#2a2a2a';
        ctx.fillRect(sx - 2, sy - 20, 4, 28);
        // Lamp head
        ctx.fillStyle = '#3a3a3a';
        ctx.fillRect(sx - 6, sy - 22, 12, 4);
        ctx.fillStyle = '#f0d060';
        ctx.beginPath();
        ctx.arc(sx, sy - 24, 5, 0, Math.PI * 2);
        ctx.fill();
        ctx.globalAlpha = 0.12;
        ctx.fillStyle = '#f0d060';
        ctx.beginPath();
        ctx.arc(sx, sy - 24, 16, 0, Math.PI * 2);
        ctx.fill();
        ctx.globalAlpha = 1;
        break;
      case 'pigeon':
        ctx.fillStyle = '#7a7a8a';
        ctx.beginPath();
        ctx.ellipse(sx, sy, 5, 3, 0, 0, Math.PI * 2);
        ctx.fill();
        ctx.fillStyle = '#5a5a6a';
        ctx.beginPath();
        ctx.arc(sx + 4, sy - 2, 2.5, 0, Math.PI * 2);
        ctx.fill();
        break;
      case 'cafe_table':
        // Small caf√© table with chairs
        ctx.fillStyle = '#4a3a2a';
        ctx.beginPath();
        ctx.arc(sx, sy, 7, 0, Math.PI * 2);
        ctx.fill();
        ctx.fillStyle = '#e8d0a0';
        ctx.beginPath();
        ctx.arc(sx, sy, 5, 0, Math.PI * 2);
        ctx.fill();
        // Chairs
        ctx.fillStyle = '#5a4a3a';
        ctx.fillRect(sx - 10, sy - 2, 4, 4);
        ctx.fillRect(sx + 6, sy - 2, 4, 4);
        break;
      case 'bougainvillea':
        // Bright pink/purple flowering bush
        ctx.fillStyle = '#3a6a2a';
        ctx.beginPath();
        ctx.arc(sx, sy, 7, 0, Math.PI * 2);
        ctx.fill();
        ctx.fillStyle = '#d030a0';
        for (let f = 0; f < 5; f++) {
          const fx = sx + Math.cos(f * 1.3) * 6;
          const fy = sy + Math.sin(f * 1.3) * 5;
          ctx.beginPath();
          ctx.arc(fx, fy, 3, 0, Math.PI * 2);
          ctx.fill();
        }
        break;
      case 'pottery':
        ctx.fillStyle = '#c06030';
        ctx.beginPath();
        ctx.ellipse(sx, sy + 3, 6, 4, 0, 0, Math.PI * 2);
        ctx.fill();
        ctx.fillRect(sx - 4, sy - 5, 8, 8);
        ctx.fillStyle = '#d07040';
        ctx.fillRect(sx - 5, sy - 6, 10, 3);
        break;
      case 'sombrero':
        ctx.fillStyle = '#c8a040';
        ctx.beginPath();
        ctx.ellipse(sx, sy, 10, 4, 0, 0, Math.PI * 2);
        ctx.fill();
        ctx.fillStyle = '#b09030';
        ctx.beginPath();
        ctx.ellipse(sx, sy - 3, 6, 4, 0, 0, Math.PI * 2);
        ctx.fill();
        break;
      case 'umbrella':
        // Beach umbrella
        const umbColors = ['#e04040', '#4040e0', '#e0e040', '#40e040'];
        ctx.fillStyle = '#8a6a3a';
        ctx.fillRect(sx - 1, sy - 8, 2, 18);
        ctx.fillStyle = umbColors[Math.floor((d.x + d.y) % umbColors.length)];
        ctx.beginPath();
        ctx.arc(sx, sy - 10, 12, Math.PI, 2 * Math.PI);
        ctx.fill();
        // Stripes
        ctx.fillStyle = '#fff';
        ctx.globalAlpha = 0.3;
        ctx.beginPath();
        ctx.moveTo(sx, sy - 10);
        ctx.lineTo(sx - 4, sy - 10);
        ctx.lineTo(sx - 2, sy - 20);
        ctx.closePath();
        ctx.fill();
        ctx.beginPath();
        ctx.moveTo(sx + 3, sy - 10);
        ctx.lineTo(sx + 7, sy - 10);
        ctx.lineTo(sx + 5, sy - 20);
        ctx.closePath();
        ctx.fill();
        ctx.globalAlpha = 1;
        break;
      case 'shell':
        ctx.fillStyle = '#f0d0b0';
        ctx.beginPath();
        ctx.ellipse(sx, sy, 4, 3, 0.5, 0, Math.PI * 2);
        ctx.fill();
        ctx.strokeStyle = '#c0a080';
        ctx.lineWidth = 0.5;
        ctx.stroke();
        break;
      case 'seagull':
        // Simple seagull shape
        ctx.strokeStyle = '#fff';
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.moveTo(sx - 8, sy + 3);
        ctx.quadraticCurveTo(sx - 3, sy - 4, sx, sy);
        ctx.quadraticCurveTo(sx + 3, sy - 4, sx + 8, sy + 3);
        ctx.stroke();
        break;
      case 'tropical_flower':
        ctx.fillStyle = '#f04080';
        ctx.beginPath();
        for (let p = 0; p < 5; p++) {
          const pa = (p / 5) * Math.PI * 2;
          ctx.moveTo(sx, sy);
          ctx.arc(sx + Math.cos(pa) * 4, sy + Math.sin(pa) * 4, 3, 0, Math.PI * 2);
        }
        ctx.fill();
        ctx.fillStyle = '#ffd700';
        ctx.beginPath();
        ctx.arc(sx, sy, 2, 0, Math.PI * 2);
        ctx.fill();
        break;
      case 'snow':
        ctx.fillStyle = 'rgba(240, 245, 255, 0.6)';
        ctx.beginPath();
        ctx.ellipse(sx, sy, 18, 10, 0.2, 0, Math.PI * 2);
        ctx.fill();
        break;
      case 'hay':
        ctx.fillStyle = '#c8a840';
        ctx.beginPath();
        ctx.arc(sx, sy, 10, 0, Math.PI * 2);
        ctx.fill();
        ctx.strokeStyle = '#a08830';
        ctx.lineWidth = 1;
        ctx.stroke();
        // Hay lines
        ctx.strokeStyle = '#b09838';
        ctx.beginPath();
        ctx.moveTo(sx - 7, sy - 3);
        ctx.lineTo(sx + 7, sy - 3);
        ctx.moveTo(sx - 6, sy + 2);
        ctx.lineTo(sx + 6, sy + 2);
        ctx.stroke();
        break;
      case 'fence':
        ctx.fillStyle = '#7a5a2a';
        ctx.fillRect(sx - 15, sy, 30, 3);
        ctx.fillRect(sx - 12, sy - 6, 3, 12);
        ctx.fillRect(sx, sy - 6, 3, 12);
        ctx.fillRect(sx + 10, sy - 6, 3, 12);
        break;
      case 'fountain': {
        // Water fountain
        ctx.fillStyle = '#8a8a8a';
        ctx.beginPath();
        ctx.ellipse(sx, sy + 5, 16, 8, 0, 0, Math.PI * 2);
        ctx.fill();
        ctx.fillStyle = '#6a6a6a';
        ctx.fillRect(sx - 3, sy - 10, 6, 15);
        // Water
        ctx.fillStyle = '#5090c0';
        ctx.beginPath();
        ctx.ellipse(sx, sy + 5, 13, 6, 0, 0, Math.PI * 2);
        ctx.fill();
        // Spray
        const sprayH = 8 + Math.sin(Date.now() * 0.006) * 3;
        ctx.strokeStyle = '#80c0f0';
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.moveTo(sx, sy - 10);
        ctx.lineTo(sx, sy - 10 - sprayH);
        ctx.stroke();
        ctx.fillStyle = 'rgba(128,192,240,0.4)';
        ctx.beginPath();
        ctx.arc(sx, sy - 10 - sprayH, 4, 0, Math.PI * 2);
        ctx.fill();
        break;
      }
      case 'mailbox': {
        ctx.fillStyle = '#d0c030';
        ctx.fillRect(sx - 4, sy - 8, 8, 12);
        ctx.fillRect(sx - 6, sy - 10, 12, 4);
        ctx.fillStyle = '#3a3a3a';
        ctx.fillRect(sx - 1, sy + 2, 3, 10);
        break;
      }
      case 'bike': {
        ctx.strokeStyle = '#3a3a3a';
        ctx.lineWidth = 1.5;
        ctx.beginPath();
        ctx.arc(sx - 6, sy + 2, 5, 0, Math.PI * 2);
        ctx.stroke();
        ctx.beginPath();
        ctx.arc(sx + 6, sy + 2, 5, 0, Math.PI * 2);
        ctx.stroke();
        ctx.beginPath();
        ctx.moveTo(sx - 6, sy + 2);
        ctx.lineTo(sx, sy - 5);
        ctx.lineTo(sx + 6, sy + 2);
        ctx.stroke();
        ctx.strokeStyle = '#c04040';
        ctx.beginPath();
        ctx.moveTo(sx - 2, sy - 5);
        ctx.lineTo(sx + 3, sy - 8);
        ctx.stroke();
        break;
      }
      case 'market_stall': {
        // Colorful market stall
        const stallColors = ['#e04040', '#4090e0', '#40c040', '#e0a030'];
        ctx.fillStyle = '#8a6a3a';
        ctx.fillRect(sx - 15, sy, 30, 15);
        ctx.fillStyle = stallColors[Math.floor((d.x + d.y) % stallColors.length)];
        ctx.fillRect(sx - 18, sy - 5, 36, 8);
        // Goods
        ctx.fillStyle = '#e0c040';
        ctx.beginPath();
        ctx.arc(sx - 6, sy + 5, 3, 0, Math.PI * 2);
        ctx.fill();
        ctx.fillStyle = '#e06040';
        ctx.beginPath();
        ctx.arc(sx + 4, sy + 5, 3, 0, Math.PI * 2);
        ctx.fill();
        break;
      }
      case 'surfboard': {
        ctx.fillStyle = ['#e04080', '#40c0e0', '#e0e040'][Math.floor((d.x * 3) % 3)];
        ctx.save();
        ctx.translate(sx, sy);
        ctx.rotate(0.3);
        ctx.beginPath();
        ctx.ellipse(0, 0, 4, 16, 0, 0, Math.PI * 2);
        ctx.fill();
        ctx.strokeStyle = '#fff';
        ctx.lineWidth = 1;
        ctx.beginPath();
        ctx.moveTo(0, -10);
        ctx.lineTo(0, 10);
        ctx.stroke();
        ctx.restore();
        break;
      }
      case 'hammock': {
        ctx.strokeStyle = '#c09050';
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.moveTo(sx - 20, sy - 5);
        ctx.quadraticCurveTo(sx, sy + 10, sx + 20, sy - 5);
        ctx.stroke();
        // Ropes
        ctx.strokeStyle = '#8a6a3a';
        ctx.lineWidth = 1;
        ctx.beginPath();
        ctx.moveTo(sx - 20, sy - 5);
        ctx.lineTo(sx - 22, sy - 15);
        ctx.moveTo(sx + 20, sy - 5);
        ctx.lineTo(sx + 22, sy - 15);
        ctx.stroke();
        break;
      }
      case 'statue': {
        // Classical statue on pedestal
        ctx.fillStyle = '#a0a0a0';
        ctx.fillRect(sx - 8, sy + 2, 16, 10);
        ctx.fillStyle = '#c0c0c0';
        ctx.fillRect(sx - 4, sy - 18, 8, 20);
        // Head
        ctx.beginPath();
        ctx.arc(sx, sy - 22, 5, 0, Math.PI * 2);
        ctx.fill();
        break;
      }
      case 'kiosk': {
        // Newspaper kiosk
        ctx.fillStyle = '#2a5a2a';
        ctx.fillRect(sx - 12, sy - 10, 24, 20);
        ctx.fillStyle = '#3a7a3a';
        ctx.fillRect(sx - 14, sy - 14, 28, 6);
        // Papers
        ctx.fillStyle = '#f0f0e0';
        ctx.fillRect(sx - 8, sy - 6, 6, 8);
        ctx.fillRect(sx + 2, sy - 6, 6, 8);
        break;
      }
      case 'goat': {
        ctx.fillStyle = '#c0b0a0';
        ctx.beginPath();
        ctx.ellipse(sx, sy, 6, 4, 0, 0, Math.PI * 2);
        ctx.fill();
        ctx.beginPath();
        ctx.arc(sx + 5, sy - 2, 3, 0, Math.PI * 2);
        ctx.fill();
        // Horns
        ctx.strokeStyle = '#5a4a3a';
        ctx.lineWidth = 1;
        ctx.beginPath();
        ctx.moveTo(sx + 6, sy - 4);
        ctx.lineTo(sx + 8, sy - 7);
        ctx.moveTo(sx + 4, sy - 4);
        ctx.lineTo(sx + 3, sy - 7);
        ctx.stroke();
        break;
      }
      case 'cabin': {
        // Alpine cabin
        ctx.fillStyle = '#6a4a2a';
        ctx.fillRect(sx - 15, sy - 5, 30, 20);
        // Roof
        ctx.fillStyle = '#8a3a1a';
        ctx.beginPath();
        ctx.moveTo(sx - 18, sy - 5);
        ctx.lineTo(sx, sy - 18);
        ctx.lineTo(sx + 18, sy - 5);
        ctx.closePath();
        ctx.fill();
        // Window
        ctx.fillStyle = '#f0d060';
        ctx.fillRect(sx - 4, sy, 8, 6);
        // Door
        ctx.fillStyle = '#4a2a0a';
        ctx.fillRect(sx + 6, sy + 2, 6, 12);
        break;
      }
      case 'well': {
        ctx.fillStyle = '#7a7a7a';
        ctx.beginPath();
        ctx.ellipse(sx, sy, 10, 6, 0, 0, Math.PI * 2);
        ctx.fill();
        ctx.fillStyle = '#5a5a5a';
        ctx.beginPath();
        ctx.ellipse(sx, sy, 8, 5, 0, 0, Math.PI * 2);
        ctx.fill();
        // Water inside
        ctx.fillStyle = '#3060a0';
        ctx.beginPath();
        ctx.ellipse(sx, sy + 1, 6, 3, 0, 0, Math.PI * 2);
        ctx.fill();
        // Posts and beam
        ctx.fillStyle = '#5a3a1a';
        ctx.fillRect(sx - 10, sy - 15, 3, 15);
        ctx.fillRect(sx + 8, sy - 15, 3, 15);
        ctx.fillRect(sx - 10, sy - 17, 21, 3);
        break;
      }
      case 'wheelbarrow': {
        ctx.fillStyle = '#6a8a3a';
        ctx.beginPath();
        ctx.moveTo(sx - 10, sy);
        ctx.lineTo(sx + 6, sy);
        ctx.lineTo(sx + 10, sy + 6);
        ctx.lineTo(sx - 8, sy + 6);
        ctx.closePath();
        ctx.fill();
        // Wheel
        ctx.strokeStyle = '#3a3a3a';
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.arc(sx + 12, sy + 8, 4, 0, Math.PI * 2);
        ctx.stroke();
        // Handle
        ctx.strokeStyle = '#5a3a1a';
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.moveTo(sx - 10, sy);
        ctx.lineTo(sx - 18, sy - 5);
        ctx.moveTo(sx - 8, sy + 6);
        ctx.lineTo(sx - 18, sy - 5);
        ctx.stroke();
        break;
      }
      case 'chicken': {
        ctx.fillStyle = '#d0a050';
        ctx.beginPath();
        ctx.ellipse(sx, sy, 4, 3, 0, 0, Math.PI * 2);
        ctx.fill();
        ctx.fillStyle = '#e0b060';
        ctx.beginPath();
        ctx.arc(sx + 3, sy - 2, 2, 0, Math.PI * 2);
        ctx.fill();
        // Beak
        ctx.fillStyle = '#e08020';
        ctx.beginPath();
        ctx.moveTo(sx + 5, sy - 2);
        ctx.lineTo(sx + 7, sy - 1.5);
        ctx.lineTo(sx + 5, sy - 1);
        ctx.fill();
        // Comb
        ctx.fillStyle = '#e03030';
        ctx.beginPath();
        ctx.arc(sx + 3, sy - 4, 1.5, 0, Math.PI * 2);
        ctx.fill();
        break;
      }
      case 'papel_picado': {
        // Mexican paper banner (string of colored triangles)
        ctx.strokeStyle = '#5a4a3a';
        ctx.lineWidth = 1;
        ctx.beginPath();
        ctx.moveTo(sx - 30, sy);
        ctx.lineTo(sx + 30, sy);
        ctx.stroke();
        const ppColors = ['#e04040', '#40c040', '#e0e040', '#e060c0', '#40a0e0'];
        for (let pp = 0; pp < 5; pp++) {
          const px3 = sx - 24 + pp * 12;
          ctx.fillStyle = ppColors[pp % ppColors.length];
          ctx.beginPath();
          ctx.moveTo(px3, sy);
          ctx.lineTo(px3 + 10, sy);
          ctx.lineTo(px3 + 5, sy + 8);
          ctx.closePath();
          ctx.fill();
        }
        break;
      }
      case 'butterfly': {
        // Animated butterfly
        const bTime = Date.now() * 0.005 + d.x;
        const bx2 = sx + Math.sin(bTime) * 15;
        const by2 = sy + Math.cos(bTime * 0.7) * 8;
        const wingSpread = Math.abs(Math.sin(Date.now() * 0.01 + d.x));
        const bColors = ['#e06090', '#f0a030', '#60a0e0', '#e0e040'];
        ctx.fillStyle = bColors[Math.floor((d.x * 3 + d.y) % bColors.length)];
        ctx.beginPath();
        ctx.ellipse(bx2 - 4, by2, 4, 3 * wingSpread, -0.3, 0, Math.PI * 2);
        ctx.fill();
        ctx.beginPath();
        ctx.ellipse(bx2 + 4, by2, 4, 3 * wingSpread, 0.3, 0, Math.PI * 2);
        ctx.fill();
        // Body
        ctx.fillStyle = '#2a2a2a';
        ctx.fillRect(bx2 - 0.5, by2 - 3, 1, 6);
        break;
      }
      case 'swallow': {
        // Animated bird in flight
        const sTime = Date.now() * 0.003 + d.x * 0.1;
        const sx2 = sx + Math.sin(sTime) * 30;
        const sy2 = sy + Math.cos(sTime * 0.5) * 10;
        ctx.strokeStyle = '#2a2a3a';
        ctx.lineWidth = 1.5;
        const wingY = Math.sin(Date.now() * 0.015 + d.x) * 4;
        ctx.beginPath();
        ctx.moveTo(sx2 - 8, sy2 + wingY);
        ctx.quadraticCurveTo(sx2 - 3, sy2 - 3, sx2, sy2);
        ctx.quadraticCurveTo(sx2 + 3, sy2 - 3, sx2 + 8, sy2 + wingY);
        ctx.stroke();
        break;
      }
      case 'pond':
        ctx.fillStyle = '#3a7ab0';
        ctx.beginPath();
        ctx.ellipse(sx, sy, 30, 20, 0, 0, Math.PI * 2);
        ctx.fill();
        ctx.strokeStyle = '#2a6a90';
        ctx.lineWidth = 2;
        ctx.stroke();
        // Water ripples
        ctx.strokeStyle = 'rgba(255,255,255,0.2)';
        ctx.lineWidth = 1;
        ctx.beginPath();
        ctx.ellipse(sx - 5, sy - 3, 8, 4, 0, 0, Math.PI * 2);
        ctx.stroke();
        ctx.beginPath();
        ctx.ellipse(sx + 8, sy + 5, 6, 3, 0, 0, Math.PI * 2);
        ctx.stroke();
        // Lily pad
        ctx.fillStyle = '#3a8a3a';
        ctx.beginPath();
        ctx.arc(sx - 8, sy + 4, 5, 0, Math.PI * 2);
        ctx.fill();
        break;
    }
    ctx.textAlign = 'left';
  }
}

function drawItems() {
  for (const item of items) {
    if (item.picked) continue;
    const sx = item.x - camX;
    const sy = item.y - camY;
    if (sx < -30 || sx > canvas.width + 30 || sy < -30 || sy > canvas.height + 30) continue;

    // Floating animation
    const floatY = Math.sin(Date.now() * 0.003 + item.x) * 5;
    ctx.font = '28px serif';
    ctx.textAlign = 'center';
    ctx.fillText(item.emoji, sx, sy + floatY);

    // Glow
    ctx.beginPath();
    ctx.arc(sx, sy + floatY - 5, 18, 0, Math.PI * 2);
    ctx.fillStyle = 'rgba(255, 220, 100, 0.15)';
    ctx.fill();
    ctx.textAlign = 'left';
  }
}

function drawNPCs() {
  for (const npc of npcs) {
    const sx = npc.x - camX;
    const sy = npc.y - camY;
    if (sx < -40 || sx > canvas.width + 40 || sy < -40 || sy > canvas.height + 40) continue;

    // Shadow
    ctx.fillStyle = 'rgba(0,0,0,0.2)';
    ctx.beginPath();
    ctx.ellipse(sx, sy + 16, 12, 5, 0, 0, Math.PI * 2);
    ctx.fill();

    // Body
    ctx.fillStyle = npc.color;
    ctx.beginPath();
    ctx.arc(sx, sy, 14, 0, Math.PI * 2);
    ctx.fill();
    ctx.strokeStyle = 'rgba(0,0,0,0.3)';
    ctx.lineWidth = 2;
    ctx.stroke();

    // Emoji face
    ctx.font = '18px serif';
    ctx.textAlign = 'center';
    ctx.fillText(npc.emoji, sx, sy + 6);

    // Candle
    if (npc.hasCandle) {
      ctx.font = '14px serif';
      ctx.fillText('üïØÔ∏è', sx + 16, sy - 10);
    }

    // Name
    ctx.fillStyle = '#fff';
    ctx.font = 'bold 11px Georgia';
    ctx.fillText(npc.name, sx, sy - 22);
    ctx.textAlign = 'left';

    // Dance animation during end sequence
    if (endSequenceActive) {
      const angle = (Date.now() * 0.005 + npc.x) % (Math.PI * 2);
      const danceX = Math.cos(angle) * 8;
      const danceY = Math.sin(angle * 2) * 4;
      npc.x += danceX * 0.02;
      npc.y += danceY * 0.02;
    }
  }
}

function drawPlayer() {
  const sx = gameState.playerX - camX;
  const sy = gameState.playerY - camY;

  // Shadow
  ctx.fillStyle = 'rgba(0,0,0,0.3)';
  ctx.beginPath();
  ctx.ellipse(sx, sy + 18, 14, 6, 0, 0, Math.PI * 2);
  ctx.fill();

  // Body
  ctx.fillStyle = '#f5c842';
  ctx.beginPath();
  ctx.arc(sx, sy, 16, 0, Math.PI * 2);
  ctx.fill();
  ctx.strokeStyle = '#c9a020';
  ctx.lineWidth = 2;
  ctx.stroke();

  // Hair (brunette)
  ctx.fillStyle = '#4a2a0a';
  ctx.beginPath();
  ctx.arc(sx, sy - 6, 14, Math.PI, 2 * Math.PI);
  ctx.fill();
  // Side hair
  ctx.fillRect(sx - 14, sy - 6, 5, 18);
  ctx.fillRect(sx + 9, sy - 6, 5, 18);

  // Face
  ctx.fillStyle = '#f0c8a0';
  ctx.beginPath();
  ctx.arc(sx, sy + 2, 10, 0, Math.PI * 2);
  ctx.fill();

  // Eyes
  ctx.fillStyle = '#3a2010';
  ctx.beginPath();
  ctx.arc(sx - 4, sy, 1.5, 0, Math.PI * 2);
  ctx.arc(sx + 4, sy, 1.5, 0, Math.PI * 2);
  ctx.fill();

  // Smile
  ctx.strokeStyle = '#c06040';
  ctx.lineWidth = 1.5;
  ctx.beginPath();
  ctx.arc(sx, sy + 3, 4, 0.1 * Math.PI, 0.9 * Math.PI);
  ctx.stroke();

  ctx.textAlign = 'center';

  // Name
  ctx.fillStyle = '#f5c842';
  ctx.font = 'bold 12px Georgia';
  ctx.fillText('Ana Lucila', sx, sy - 24);
  ctx.textAlign = 'left';

  // Movement indicator
  if (gameState.targetX !== null) {
    ctx.fillStyle = 'rgba(245, 200, 66, 0.4)';
    ctx.beginPath();
    const tx = gameState.targetX - camX;
    const ty = gameState.targetY - camY;
    ctx.arc(tx, ty, 8 + Math.sin(Date.now() * 0.005) * 3, 0, Math.PI * 2);
    ctx.fill();
  }
}

function drawEndSequenceCake() {
  if (!endSequenceActive) return;
  const vo = regionOrigin('velizy');
  const cx = vo.x + 350 - camX;
  const cy = vo.y + 750 - camY;

  // Big cake
  ctx.font = '60px serif';
  ctx.textAlign = 'center';
  ctx.fillText('üéÇ', cx, cy + 20);

  // Candles around cake
  for (let i = 0; i < 7; i++) {
    const angle = (i / 7) * Math.PI * 2 + Date.now() * 0.002;
    const radius = 50;
    const candleX = cx + Math.cos(angle) * radius;
    const candleY = cy + Math.sin(angle) * radius;
    ctx.font = '20px serif';
    ctx.fillText('üïØÔ∏è', candleX, candleY);
  }

  // Confetti
  for (let i = 0; i < 30; i++) {
    const t = Date.now() * 0.001 + i * 100;
    const confX = cx + Math.sin(t + i) * (80 + i * 3);
    const confY = cy - 80 + Math.cos(t * 0.5 + i) * 40 + (endSequenceTimer * 0.5) % 100;
    ctx.fillStyle = ['#f5c842', '#e07050', '#70b0e0', '#a070c0', '#4a9e4a'][i % 5];
    ctx.fillRect(confX, confY, 6, 6);
  }

  ctx.textAlign = 'left';
}

function drawTelePheriqueButton() {
  // Draw clickable egg at bottom station
  const region = getCurrentRegion(gameState.playerX, gameState.playerY);
  if (region !== 'grenoble') return;

  const sx = TELEPHERIQUE.bottomX - camX;
  const sy = TELEPHERIQUE.bottomY - camY;

  ctx.font = '30px serif';
  ctx.textAlign = 'center';
  ctx.fillText('ü•ö', sx, sy + 10);
  ctx.fillStyle = '#ff0';
  ctx.font = 'bold 11px Georgia';
  ctx.fillText('T√©l√©ph√©rique', sx, sy + 30);
  ctx.textAlign = 'left';
}

// ---- Mini-map ----
const minimapCanvas = document.getElementById('minimap-canvas');
const mctx = minimapCanvas.getContext('2d');
const MM_W = 160, MM_H = 106;
const MM_SCALE_X = MM_W / WORLD_W;
const MM_SCALE_Y = MM_H / WORLD_H;

function drawMinimap() {
  mctx.clearRect(0, 0, MM_W, MM_H);
  // Regions
  for (const [key, r] of Object.entries(REGIONS)) {
    const rx = r.col * REGION_W * MM_SCALE_X;
    const ry = r.row * REGION_H * MM_SCALE_Y;
    const rw = REGION_W * MM_SCALE_X;
    const rh = REGION_H * MM_SCALE_Y;
    mctx.fillStyle = r.color;
    mctx.fillRect(rx, ry, rw, rh);
    mctx.strokeStyle = 'rgba(255,255,255,0.4)';
    mctx.lineWidth = 0.5;
    mctx.strokeRect(rx, ry, rw, rh);
    // Region name
    mctx.fillStyle = 'rgba(255,255,255,0.7)';
    mctx.font = '6px Georgia';
    mctx.textAlign = 'center';
    mctx.fillText(r.name, rx + rw/2, ry + rh/2 + 2);
  }
  // NPCs as dots
  for (const npc of npcs) {
    if (npc.hasCandle) {
      mctx.fillStyle = '#f5c842';
      mctx.beginPath();
      mctx.arc(npc.x * MM_SCALE_X, npc.y * MM_SCALE_Y, 2, 0, Math.PI * 2);
      mctx.fill();
    }
  }
  // Player
  mctx.fillStyle = '#ff4444';
  mctx.beginPath();
  mctx.arc(gameState.playerX * MM_SCALE_X, gameState.playerY * MM_SCALE_Y, 3, 0, Math.PI * 2);
  mctx.fill();
  mctx.strokeStyle = '#fff';
  mctx.lineWidth = 1;
  mctx.stroke();
  mctx.textAlign = 'left';
}

// ---- Main render ----
function render() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);

  drawGround();
  drawBuildings();
  drawMaze();
  drawDecorations();
  drawItems();
  drawTelePheriqueButton();
  drawNPCs();
  drawPlayer();
  drawEndSequenceCake();
  drawMinimap();
}

// ---- Game Loop ----
let running = false;

function gameLoop() {
  if (!running) return;
  update();
  render();
  updateHUD();
  requestAnimationFrame(gameLoop);
}

// ---- Start Game ----
function startGame(isNew) {
  buildWorld();
  initMazeDecos();
  npcs = createNPCs();
  items = createItems();

  if (isNew) {
    gameState = newGameState();
  } else {
    gameState = newGameState(); // default
    loadGame(); // overwrite with saved
  }

  document.getElementById('start-screen').style.display = 'none';
  document.getElementById('hud').style.display = 'block';
  document.getElementById('minimap').style.display = 'block';
  updateCamera();
  updateHUD();
  running = true;

  if (isNew) {
    setTimeout(() => {
      showDialogue('G√©rard', 'Joyeux anniversaire ! Tu as parl√© √† tout le monde ? Va voir les personnages avec une bougie dans chaque r√©gion !');
    }, 300);
  }

  gameLoop();
}

// ---- UI Events ----
document.getElementById('btn-new').addEventListener('click', () => {
  localStorage.removeItem('elViaje_save');
  startGame(true);
});

document.getElementById('btn-continue').addEventListener('click', () => {
  startGame(false);
});

document.getElementById('btn-restart').addEventListener('click', () => {
  document.getElementById('end-screen').style.display = 'none';
  localStorage.removeItem('elViaje_save');
  running = false;
  endSequenceActive = false;
  dialogueQueue = [];
  dialogueActive = false;
  document.getElementById('dialogue-box').style.display = 'none';
  document.getElementById('start-screen').style.display = 'flex';
  checkContinueButton();
});

function checkContinueButton() {
  document.getElementById('btn-continue').disabled = !hasSave();
}
checkContinueButton();
</script>
</body>
</html>
